<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Future JEE Crackers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
        }
        .app-wrapper {
            width: 100%;
            max-width: 42rem;
            min-height: 100vh;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }
        .screen {
            display: none;
            flex-direction: column;
            flex-grow: 1;
            width: 100%;
            animation: fadeIn 0.5s ease-in-out;
        }
        .screen.active {
            display: flex;
        }
        .gradient-text {
            background: linear-gradient(45deg, #4f46e5, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .button-primary {
            background-color: #4f46e5; color: white; padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .button-primary:hover:not(:disabled) { background-color: #4338ca; transform: translateY(-2px); box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15); }
        .button-primary:disabled { background-color: #a5b4fc; cursor: not-allowed; }
        .button-secondary { background-color: #e0e7ff; color: #4f46e5; padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 600; transition: all 0.3s ease; }
        .button-secondary:hover { background-color: #c7d2fe; }
        .bottom-nav { display: flex; border-top: 1px solid #e5e7eb; background-color: #ffffff; }
        .nav-item { flex: 1; text-align: center; padding: 0.75rem 0; color: #6b7280; cursor: pointer; transition: all 0.2s ease; border-top: 3px solid transparent; }
        .nav-item.active { color: #4f46e5; border-top-color: #4f46e5; }
        .nav-item:hover { background-color: #f9fafb; }
        .nav-item svg { margin: 0 auto 0.25rem; }
        
        .modal-backdrop { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); z-index: 40; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; }
        .subject-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; }
        .exam-question { scroll-margin-top: 80px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <main class="flex-grow flex flex-col">
            <!-- Loading Screen -->
            <div id="loading-screen" class="screen active flex-col justify-center items-center p-8">
                <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-indigo-600"></div>
                <h1 class="text-3xl font-bold mt-6 gradient-text">Future JEE Crackers</h1>
                <p class="text-slate-500 mt-2">by ARVIND DARA BISHNOI</p>
            </div>

            <!-- Original Intro/Login Screens -->
            <div id="intro-screen" class="screen justify-center items-center">
                <h1 class="text-5xl font-bold gradient-text">ARVIND DARA BISHNOI</h1>
            </div>
            <div id="main-screen" class="screen flex-col justify-center items-center p-8 space-y-4">
                <h2 class="text-3xl font-bold text-gray-800 mb-8">Welcome!</h2>
                <button id="have-account-btn" class="button-primary w-full max-w-sm">Existing Account</button>
                <button id="new-user-btn" class="button-secondary w-full max-w-sm">New User</button>
            </div>
            <div id="new-user-screen" class="screen flex-col justify-center items-center p-8 space-y-4">
                <button class="back-btn absolute top-4 left-4 p-2 rounded-full hover:bg-slate-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                <h2 class="text-2xl font-bold text-gray-800">What is your full name?</h2>
                <input type="text" id="new-user-name-input" placeholder="Enter your full name" class="p-3 border rounded-lg w-full max-w-sm">
                <button id="create-user-btn" class="button-primary w-full max-w-sm">Create Account</button>
            </div>
            <div id="have-account-screen" class="screen flex-col justify-center items-center p-8 space-y-4">
                <button class="back-btn absolute top-4 left-4 p-2 rounded-full hover:bg-slate-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                <h2 class="text-2xl font-bold text-gray-800">Enter your ID</h2>
                <input type="text" id="existing-user-id-input" placeholder="Enter your User ID" class="p-3 border rounded-lg w-full max-w-sm">
                <button id="login-btn" class="button-primary w-full max-w-sm">Log In</button>
            </div>

            <!-- Home Screen -->
            <div id="home-screen" class="screen flex-col p-4 md:p-6 space-y-4 overflow-y-auto">
                <header>
                    <h1 id="welcome-message" class="text-2xl font-bold text-slate-800">Hello!</h1>
                    <p class="text-slate-500">Ready to conquer JEE?</p>
                </header>
                <div id="announcement-box" class="bg-indigo-50 border-l-4 border-indigo-500 text-indigo-800 p-4 rounded-r-lg shadow-sm hidden">
                    <p class="font-bold">Announcement</p>
                    <p id="announcement-text"></p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4">
                    <button id="prep-by-syllabus-btn" class="bg-indigo-600 text-white p-6 rounded-xl shadow-lg hover:bg-indigo-700 transition text-left space-y-2">
                        <h2 class="text-xl font-bold">JEE Main Preparation</h2>
                        <p class="text-indigo-200">Practice tests by syllabus.</p>
                    </button>
                    <button id="daily-rank-test-btn" class="bg-pink-600 text-white p-6 rounded-xl shadow-lg hover:bg-pink-700 transition text-left space-y-2">
                        <h2 class="text-xl font-bold">Daily JEE Rank Series</h2>
                        <p class="text-pink-200">Compete in a live test.</p>
                    </button>
                    <button id="scoreboard-btn" class="bg-green-600 text-white p-6 rounded-xl shadow-lg hover:bg-green-700 transition text-left space-y-2">
                        <h2 class="text-xl font-bold">Daily Score Board</h2>
                        <p class="text-green-200">Check ranks and top performers.</p>
                    </button>
                    <div class="bg-amber-500 text-white p-6 rounded-xl shadow-lg text-left space-y-2">
                        <h2 class="text-xl font-bold">All India JEE+Advanced</h2>
                        <p id="all-india-test-countdown" class="text-amber-200">Starts in 7 days!</p>
                    </div>
                </div>
                <div class="pt-6">
                    <button id="feedback-btn" class="w-full text-center py-4 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition font-semibold">What new features do you want?</button>
                </div>
            </div>
            
            <!-- Chat Screen -->
            <div id="chat-screen" class="screen flex-col">
                <header class="p-4 border-b font-bold text-lg text-center">Global Chat</header>
                <div id="chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto flex flex-col-reverse"></div>
                <form id="chat-form" class="p-4 border-t flex gap-2">
                    <input type="text" id="chat-input" placeholder="Type a message..." class="flex-grow p-3 border rounded-full">
                    <button type="submit" class="bg-indigo-600 text-white rounded-full p-3 flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009.894 15V4.106A1 1 0 0010.894 2.553z" /></svg></button>
                </form>
            </div>

            <!-- Profile Screen -->
            <div id="profile-screen" class="screen flex-col p-6 space-y-6 overflow-y-auto">
                 <h2 class="text-3xl font-bold text-gray-800 gradient-text">Profile</h2>
                <div class="bg-slate-100 p-4 rounded-lg">
                    <p class="font-semibold text-gray-700 mb-1">Your User ID:</p>
                    <div class="flex items-center justify-between">
                        <p id="display-user-id" class="font-mono text-gray-600 break-all text-sm"></p>
                        <button id="copy-id-btn" class="ml-2 px-3 py-1 bg-gray-200 text-gray-700 text-xs rounded-md hover:bg-gray-300 transition">Copy</button>
                    </div>
                </div>
                <div class="bg-slate-100 p-4 rounded-lg">
                    <p class="font-semibold text-gray-700 mb-1">Your Name:</p>
                    <input type="text" id="profile-name-input" class="p-2 border rounded-lg w-full mb-2">
                    <button id="save-name-btn" class="button-primary w-full text-sm py-2">Save Name</button>
                </div>
                <div class="bg-slate-100 p-4 rounded-lg">
                    <p class="font-semibold text-gray-700 mb-1">भाषा चुनें (Language):</p>
                    <select id="language-select" class="w-full p-3 border rounded-lg bg-white">
                        <option value="english">English</option>
                        <option value="hindi" selected>हिंदी (Hindi)</option>
                    </select>
                </div>
                <a href="http://www.youtube.com/@RAVI..BHAI_0029" target="_blank" class="button-secondary w-full text-center">Check Channel</a>
                <button id="logout-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg">Logout</button>
            </div>

            <!-- JEE Screens -->
            <div id="jee-prep-setup-screen" class="screen flex-col p-4 md:p-6 space-y-4 overflow-y-auto">
                <header class="flex items-center">
                    <button class="back-btn p-2 rounded-full hover:bg-slate-200 mr-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                    <h1 class="text-2xl font-bold">Create Your Test</h1>
                </header>
                <div class="space-y-6 pt-4">
                    <div>
                        <h3 class="font-semibold mb-2">1. Select Class</h3>
                        <select id="class-select" class="w-full p-3 border rounded-lg bg-white"><option value="11">Class 11</option><option value="12">Class 12</option><option value="11,12" selected>Full Syllabus (11th + 12th)</option></select>
                    </div>
                    <div>
                        <h3 class="font-semibold mb-2">2. Select Subjects</h3>
                        <div id="subject-selection" class="subject-grid"></div>
                    </div>
                    <div>
                        <h3 class="font-semibold mb-2">3. Select Difficulty</h3>
                        <div class="flex gap-4"><label class="flex-1"><input type="radio" name="difficulty" value="Basic" class="mr-2">Basic</label><label class="flex-1"><input type="radio" name="difficulty" value="JEE Main" class="mr-2" checked>JEE Main</label><label class="flex-1"><input type="radio" name="difficulty" value="JEE Advanced" class="mr-2">JEE Advanced</label></div>
                    </div>
                    <button id="generate-test-btn" class="w-full button-primary py-4 font-bold shadow-lg">Generate Test</button>
                </div>
            </div>
            <div id="exam-screen" class="screen flex-col">
                <header class="sticky top-0 bg-white shadow-md z-10 p-4 flex justify-between items-center">
                    <h1 id="exam-title" class="text-xl font-bold">Test in Progress</h1>
                    <div id="exam-timer" class="font-bold text-lg text-indigo-600">03:00:00</div>
                </header>
                <div id="exam-content" class="p-4 md:p-6 space-y-8 overflow-y-auto flex-grow bg-slate-50"></div>
                <footer class="sticky bottom-0 bg-white p-4 border-t"><button id="submit-exam-btn" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition">Submit Test</button></footer>
            </div>
            <div id="result-screen" class="screen flex-col justify-center items-center p-8">
                 <h1 class="text-4xl font-bold mb-4 gradient-text">Test Complete!</h1>
                 <div class="text-center bg-slate-100 p-8 rounded-2xl shadow-lg w-full max-w-md">
                    <p class="text-lg text-slate-600">Your Score</p><p id="result-score" class="text-7xl font-bold my-4">--/300</p>
                    <div class="grid grid-cols-3 gap-4 text-center"><p class="font-semibold">Correct</p><p id="result-correct" class="text-2xl font-bold text-green-600">0</p><p class="font-semibold">Incorrect</p><p id="result-incorrect" class="text-2xl font-bold text-red-600">0</p><p class="font-semibold">Unanswered</p><p id="result-unanswered" class="text-2xl font-bold text-slate-500">0</p></div>
                 </div>
                 <button id="back-to-home-btn" class="mt-12 bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition">Back to Home</button>
            </div>
            <div id="scoreboard-screen" class="screen flex-col p-4 md:p-6">
                <header class="flex items-center mb-4">
                    <button class="back-btn p-2 rounded-full hover:bg-slate-200 mr-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                    <h1 class="text-2xl font-bold">Daily Test Scoreboard</h1>
                </header>
                <div id="scoreboard-info" class="text-center text-slate-500 p-2 bg-slate-100 rounded-md mb-4">Scores are updated 2 hours after test submission.</div>
                <div id="scoreboard-list" class="space-y-2 overflow-y-auto flex-grow"><p class="text-center text-slate-500 p-8">Loading scoreboard...</p></div>
            </div>

        </main>
        
        <!-- Bottom Nav -->
        <nav id="bottom-nav" class="bottom-nav hidden">
            <div id="nav-home" class="nav-item active">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                <span>होम</span>
            </div>
            <div id="nav-chat" class="nav-item">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                <span>चैट</span>
            </div>
            <div id="nav-profile" class="nav-item">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                <span>प्रोफाइल</span>
            </div>
        </nav>
        <footer id="app-footer" class="text-center p-2 text-xs text-slate-400 opacity-50 hidden">Created by Arvind Dara Bishnoi</footer>
    </div>
    
    <!-- Modals Container -->
    <div id="modal-container" class="hidden">
        <div class="modal-backdrop"></div>
        <div id="message-modal" class="modal bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm text-center">
            <h3 id="message-modal-title" class="text-xl font-bold mb-4">Alert</h3>
            <p id="message-modal-text" class="text-slate-600 mb-6"></p>
            <button id="message-modal-ok-btn" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">OK</button>
        </div>
        <div id="feedback-modal" class="modal bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-md hidden">
             <h3 class="text-xl font-bold mb-4">Your Feedback</h3>
             <p class="text-slate-600 mb-4">What new features or improvements would you like? (Once per day)</p>
             <textarea id="feedback-input" class="w-full p-2 border rounded-lg h-28" placeholder="Type here..."></textarea>
             <div class="flex gap-4 mt-4"><button id="feedback-cancel-btn" class="flex-1 bg-slate-200 py-2 rounded-lg">Cancel</button><button id="feedback-submit-btn" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg">Submit</button></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, updateDoc, query, where, onSnapshot, addDoc, getDocs, orderBy, serverTimestamp, limit, Timestamp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // --- CONFIG & GLOBAL VARS ---
        const GEMINI_API_KEY = "AIzaSyCsxr987Sb41cI13aJ0PyfOYxCuNWH3p-0"; // API key will be provided by the environment
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
        const firebaseConfig = {
            apiKey: "AIzaSyC3faZ16ZTsIUBEfI9dl55RnDklVeWIHts",
            authDomain: "arvind-dara.firebaseapp.com",
            projectId: "arvind-dara",
            storageBucket: "arvind-dara.appspot.com",
            messagingSenderId: "341922555843",
            appId: "1:341922555843:web:cefd0e44e5d8afae4fbf76"
        };
        let app, db, auth, currentUser, userData, applicationUserId, currentUserName;
        let screenHistory = [];
        let unsubscribeChat = null;
        let currentExamData = null;
        let examTimerInterval = null;
        let generationTimerInterval = null; // Timer for AI generation
        let tabSwitchCount = 0;
        let modalOkCallback = null;

        // --- DOM ELEMENTS ---
        const allScreens = document.querySelectorAll('.screen');
        const bottomNav = document.getElementById('bottom-nav');
        const appFooter = document.getElementById('app-footer');
        const modalContainer = document.getElementById('modal-container');
        const messageModal = { el: document.getElementById('message-modal'), title: document.getElementById('message-modal-title'), text: document.getElementById('message-modal-text'), okBtn: document.getElementById('message-modal-ok-btn') };
        const feedbackModal = { el: document.getElementById('feedback-modal'), input: document.getElementById('feedback-input'), submitBtn: document.getElementById('feedback-submit-btn'), cancelBtn: document.getElementById('feedback-cancel-btn') };
        
        // --- CORE APP FLOW ---
        function showScreen(screenId, isNav = false) {
            const currentActive = document.querySelector('.screen.active');
            if (currentActive && currentActive.id !== screenId && !isNav) {
                screenHistory.push(currentActive.id);
            }
            if (isNav) screenHistory = [];

            allScreens.forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');

            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            let associatedNav = document.getElementById(`nav-${screenId.replace('-screen', '')}`);
            if(associatedNav) associatedNav.classList.add('active');
            else document.getElementById('nav-home').classList.add('active');

            if (screenId === 'chat-screen' && !unsubscribeChat) loadMessages();
            if (screenId !== 'chat-screen' && unsubscribeChat) {
                unsubscribeChat();
                unsubscribeChat = null;
            }
        }

        function goBack() {
            if (screenHistory.length > 0) {
                const lastScreenId = screenHistory.pop();
                showScreen(lastScreenId, true);
            } else {
                showScreen('home-screen', true);
            }
        }

        function showModal(content, title = "Alert", onOk) {
            messageModal.title.textContent = title;
            messageModal.text.innerHTML = content;
            modalContainer.classList.remove('hidden');
            messageModal.el.classList.remove('hidden');
            feedbackModal.el.classList.add('hidden');
            modalOkCallback = onOk;
        }
        function hideModals() { 
            modalContainer.classList.add('hidden'); 
            if (typeof modalOkCallback === 'function') {
                const callback = modalOkCallback;
                modalOkCallback = null;
                callback();
            }
        }

        // --- FIREBASE & AUTH ---
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        const storedAppUserId = localStorage.getItem('arvindAppUserId');
                        if (storedAppUserId) {
                            await loadUserData(storedAppUserId);
                        } else {
                            showScreen('main-screen');
                        }
                    } else {
                        await signInAnonymously(auth);
                    }
                });
            } catch (error) { console.error("Firebase Init Error:", error); showModal("App could not start. Please refresh."); }
        }
        
        async function loadUserData(appUserIdToLoad) {
            const userRef = doc(db, "users", appUserIdToLoad);
            const userSnap = await getDoc(userRef);
            if (userSnap.exists()) {
                userData = userSnap.data();
                applicationUserId = appUserIdToLoad;
                currentUserName = userData.name || "User";
                setupAppForUser();
            } else {
                localStorage.removeItem('arvindAppUserId');
                showScreen('main-screen');
            }
        }

        async function setupAppForUser() {
            document.getElementById('welcome-message').textContent = `नमस्ते, ${currentUserName}!`;
            await loadAnnouncement();
            bottomNav.classList.remove('hidden');
            appFooter.classList.remove('hidden');
            showScreen('home-screen', true);
        }
        
        // --- NEW JEE APP LOGIC ---
        function getTodayDateString() {
            return new Date().toISOString().split('T')[0]; // YYYY-MM-DD in UTC
        }
        
        async function loadAnnouncement() {
            try {
                const q = query(collection(db, "announcements"), orderBy("createdAt", "desc"), limit(1));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    const ann = querySnapshot.docs[0].data();
                    document.getElementById('announcement-text').textContent = ann.text;
                    document.getElementById('announcement-box').classList.remove('hidden');
                }
            } catch (error) { console.error("Error loading announcement:", error); }
        }

        function populateSubjects() {
            const container = document.getElementById('subject-selection');
            container.innerHTML = '';
            ["भौतिकी (Physics)", "रसायन विज्ञान (Chemistry)", "गणित (Maths)"].forEach(subject => {
                const label = document.createElement('label');
                label.className = "flex items-center p-3 border rounded-lg bg-white cursor-pointer has-[:checked]:bg-indigo-100 has-[:checked]:border-indigo-500";
                label.innerHTML = `<input type="checkbox" name="subject" value="${subject}" class="mr-3 h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500"><span class="font-semibold">${subject}</span>`;
                container.appendChild(label);
            });
        }

        async function generateTest(isPractice = true) {
            const subjects = [...document.querySelectorAll('input[name="subject"]:checked')].map(el => el.value);
            
            const difficulty = isPractice ? document.querySelector('input[name="difficulty"]:checked').value : 'JEE Main';
            const classSelection = isPractice ? document.getElementById('class-select').value : '11,12';
            const questionCount = isPractice ? (25 * subjects.length) : 75;
            const subjectString = isPractice ? subjects.join(', ') : "Physics, Chemistry, and Maths";

            const prompt = `Generate a ${difficulty} level practice test for JEE Main in HINDI language. Class: ${classSelection}. Subjects: ${subjectString}. Total Questions: ${questionCount}. For each question, provide: a question text, four options (A, B, C, D), the correct option letter, and a brief explanation in Hindi. Ensure questions are unique.`;
            const schema = { type: "OBJECT", properties: { "questions": { "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "subject": {"type": "STRING"}, "question": {"type": "STRING"}, "options": { "type": "OBJECT", "properties": { "A": {"type": "STRING"}, "B": {"type": "STRING"}, "C": {"type": "STRING"}, "D": {"type": "STRING"} } }, "correct_answer": {"type": "STRING"}, "explanation": {"type": "STRING"} } } } } };

            try {
                const response = await fetch(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema } }) });
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                const result = await response.json();
                const parsedData = JSON.parse(result.candidates[0].content.parts[0].text);
                
                if (isPractice) {
                    currentExamData = parsedData;
                    currentExamData.type = 'practice';
                }
                return parsedData;
            } catch (error) { 
                console.error("Test Gen Error:", error); 
                showModal("टेस्ट बनाने में विफल। कृपया फिर से प्रयास करें।");
                return null;
            }
        }

        function startExam(examData) {
            document.getElementById('exam-content').innerHTML = '';
            document.getElementById('exam-title').textContent = examData.type === 'daily' ? 'दैनिक रैंक टेस्ट' : 'अभ्यास टेस्ट';
            examData.questions.forEach((q, i) => {
                const qEl = document.createElement('div');
                qEl.className = 'exam-question bg-white p-6 rounded-lg shadow-md';
                qEl.id = `question-${i}`;
                qEl.innerHTML = `<p class="font-bold text-lg mb-4">प्रश्न ${i + 1} (${q.subject})</p><p class="mb-6 text-lg">${q.question}</p><div class="space-y-3">${Object.entries(q.options).map(([k, v]) => `<label class="flex items-center p-3 border rounded-lg cursor-pointer has-[:checked]:bg-indigo-100"><input type="radio" name="q${i}" value="${k}" class="mr-4 h-5 w-5"><span><b>${k}.</b> ${v}</span></label>`).join('')}</div>`;
                document.getElementById('exam-content').appendChild(qEl);
            });
            showScreen('exam-screen');
            startTimer(180 * 60); // 3 hours
            if (examData.type === 'daily') {
                tabSwitchCount = 0;
                document.addEventListener('visibilitychange', handleVisibilityChange);
            }
        }

        function handleVisibilityChange() {
            if (document.visibilityState === 'hidden' && document.getElementById('exam-screen').classList.contains('active') && currentExamData.type === 'daily') {
                tabSwitchCount++;
                showModal(`चेतावनी: टैब बदलना प्रतिबंधित है। आपका रैंक प्रभावित हो सकता है। स्विच: ${tabSwitchCount}`, "धोखाधड़ी की चेतावनी");
                if (tabSwitchCount >= 3) {
                    showModal("आपने 3 से अधिक बार टैब बदला है। आपका टेस्ट अपने आप जमा हो जाएगा।", "टेस्ट समाप्त", () => submitExam(true));
                }
            }
        }

        function startTimer(duration) {
            clearInterval(examTimerInterval);
            let timer = duration;
            const timerEl = document.getElementById('exam-timer');
            const updateTimerDisplay = () => {
                let h = Math.floor(timer / 3600);
                let m = Math.floor((timer % 3600) / 60);
                let s = timer % 60;
                timerEl.textContent = `${h<10?'0'+h:h}:${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
            };
            updateTimerDisplay();
            examTimerInterval = setInterval(() => {
                timer--;
                updateTimerDisplay();
                if (timer < 0) {
                    clearInterval(examTimerInterval);
                    showModal("समय समाप्त!", "Time Over", () => submitExam());
                }
            }, 1000);
        }

        async function submitExam(cheated = false) {
            clearInterval(examTimerInterval);
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            let correct = 0, incorrect = 0, unanswered = 0;
            currentExamData.questions.forEach((q, i) => {
                const sel = document.querySelector(`input[name="q${i}"]:checked`);
                if (!sel) { unanswered++; }
                else if (sel.value === q.correct_answer) { correct++; } 
                else { incorrect++; }
            });
            const score = (correct * 4) - (incorrect * 1);

            if (currentExamData.type === 'daily') {
                const finalScore = cheated ? 0 : score;
                try {
                    const dailyTestId = getTodayDateString();
                    await addDoc(collection(db, "dailyTestSubmissions"), { 
                        userId: currentUser.uid, // FIX: Use Firebase Auth UID
                        userName: currentUserName, 
                        score: finalScore, 
                        cheated, 
                        submittedAt: serverTimestamp(),
                        paperDate: dailyTestId
                    });
                    showModal(`टेस्ट सफलतापूर्वक जमा हो गया है। आपका स्कोर ${finalScore} है। परिणाम 2 घंटे बाद स्कोरबोर्ड पर अपडेट किया जाएगा।`, "सफलता", () => showScreen('home-screen', true));
                } catch (e) { console.error(e); showModal("टेस्ट जमा करने में त्रुटि।", "Error"); }
            } else {
                document.getElementById('result-score').textContent = `${score}/${currentExamData.questions.length * 4}`;
                document.getElementById('result-correct').textContent = correct;
                document.getElementById('result-incorrect').textContent = incorrect;
                document.getElementById('result-unanswered').textContent = unanswered;
                showScreen('result-screen');
            }
        }

        async function startDailyTest() {
            const btn = document.getElementById('daily-rank-test-btn');
            btn.disabled = true;
            
            const today = getTodayDateString();
            
            const submissionsRef = collection(db, "dailyTestSubmissions");
            // FIX: Use Firebase Auth UID for query
            const q = query(submissionsRef, where("userId", "==", currentUser.uid), where("paperDate", "==", today));
            const submissionSnap = await getDocs(q);

            if (!submissionSnap.empty) {
                showModal("आप आज का टेस्ट पहले ही दे चुके हैं। कृपया कल फिर प्रयास करें।", "Already Attempted");
                btn.disabled = false;
                return;
            }

            showModal("आज का टेस्ट लोड हो रहा है...", "कृपया प्रतीक्षा करें");
            const paperRef = doc(db, "dailyPaper", today);
            const paperSnap = await getDoc(paperRef);
            let paperData;

            if (paperSnap.exists()) {
                paperData = paperSnap.data();
            } else {
                const baseText = "आज के लिए एक नया टेस्ट पेपर बना रहा हूँ...";
                showModal(baseText, "Generating Test");
                let seconds = 0;
                const modalTextEl = document.getElementById('message-modal-text');
                modalTextEl.innerHTML = `${baseText}<br><br>अनुमानित समय: ${seconds} सेकंड`;
                generationTimerInterval = setInterval(() => {
                    seconds++;
                    if(!modalContainer.classList.contains('hidden')) {
                       modalTextEl.innerHTML = `${baseText}<br><br>अनुमानित समय: ${seconds} सेकंड`;
                    } else {
                        clearInterval(generationTimerInterval);
                    }
                }, 1000);

                paperData = await generateTest(false);
                
                clearInterval(generationTimerInterval);

                if (paperData) {
                    await setDoc(paperRef, { ...paperData, createdAt: serverTimestamp() });
                } else {
                    showModal("आज का टेस्ट बनाने में विफल। कृपया बाद में पुनः प्रयास करें।", "Error");
                    btn.disabled = false;
                    return;
                }
            }
            
            showModal("टेस्ट एक समय-बद्ध परीक्षा है। टैब बदलने पर आपका स्कोर 0 हो सकता है। क्या आप तैयार हैं?", "चेतावनी", () => {
                hideModals();
                currentExamData = paperData;
                currentExamData.type = 'daily';
                startExam(currentExamData);
            });
            btn.disabled = false;
        }
        
        async function loadScoreboard() {
            showScreen('scoreboard-screen');
            const listEl = document.getElementById('scoreboard-list');
            listEl.innerHTML = `<p class="text-center p-8">स्कोरबोर्ड लोड हो रहा है...</p>`;
            try {
                const today = getTodayDateString();
                const q = query(collection(db, "dailyTestSubmissions"), where("paperDate", "==", today), orderBy("score", "desc"));
                const snap = await getDocs(q);
                if (snap.empty) { 
                    listEl.innerHTML = `<p class="text-center p-8">आज के लिए कोई सबमिशन नहीं है।</p>`; 
                    return; 
                }

                const twoHoursAgo = new Date(Date.now() - 2 * 60 * 60 * 1000);
                const scoresToShow = [];
                
                snap.docs.forEach(docSnap => {
                    const data = docSnap.data();
                    if (data.submittedAt && data.submittedAt.toDate) {
                        const submissionTime = data.submittedAt.toDate();
                        if (submissionTime < twoHoursAgo) {
                            scoresToShow.push(data);
                        }
                    }
                });

                if (scoresToShow.length === 0) {
                    listEl.innerHTML = `<p class="text-center p-8">अभी तक कोई परिणाम घोषित नहीं हुआ है। परिणाम टेस्ट जमा करने के 2 घंटे बाद दिखाए जाते हैं।</p>`;
                    return;
                }
                
                listEl.innerHTML = '';
                scoresToShow.forEach((data, i) => {
                    // FIX: Use Firebase Auth UID for comparison
                    const isMe = data.userId === currentUser.uid;
                    const itemEl = document.createElement('div');
                    itemEl.className = `flex items-center p-4 rounded-lg ${isMe ? 'bg-indigo-100 border-2 border-indigo-500' : 'bg-slate-100'}`;
                    itemEl.innerHTML = `<span class="font-bold w-12 text-lg">${i + 1}.</span><span class="flex-grow font-semibold">${data.userName} ${isMe ? '(You)' : ''} ${data.cheated ? '<span class=\"text-red-500 font-normal\">(Cheated)</span>' : ''}</span><span class="font-bold text-xl text-indigo-600">${data.score}</span>`;
                    listEl.appendChild(itemEl);
                });
            } catch (error) { 
                console.error("Scoreboard Error:", error); 
                listEl.innerHTML = `<p class="text-center text-red-500 p-8">स्कोरबोर्ड लोड नहीं हो सका।</p>`; 
            }
        }

        async function openFeedbackModal() {
            const userDoc = await getDoc(doc(db, "users", applicationUserId));
            const lastFeedback = userDoc.data().lastFeedbackTimestamp;
            if (lastFeedback && (new Date() - lastFeedback.toDate()) / (1000 * 3600) < 24) {
                showModal("आप प्रति दिन केवल एक बार फ़ीडबैक जमा कर सकते हैं।", "Cooldown"); return;
            }
            feedbackModal.input.value = '';
            modalContainer.classList.remove('hidden');
            feedbackModal.el.classList.remove('hidden');
            messageModal.el.classList.add('hidden');
        }

        async function submitFeedback() {
            const text = feedbackModal.input.value.trim();
            if (text.length < 10) { showModal("कृपया अधिक विस्तृत फ़ीडबैक प्रदान करें।"); return; }
            feedbackModal.submitBtn.disabled = true;
            try {
                await addDoc(collection(db, "feedback"), { 
                    userId: currentUser.uid, // FIX: Use Firebase Auth UID
                    userName: currentUserName, 
                    feedback: text, 
                    createdAt: serverTimestamp() 
                });
                await updateDoc(doc(db, "users", applicationUserId), { lastFeedbackTimestamp: serverTimestamp() });
                hideModals();
                showModal("आपके फ़ीडबैक के लिए धन्यवाद!", "Success");
            } catch (error) { console.error(error); showModal("फ़ीडबैक जमा करने में त्रुटि।");
            } finally { feedbackModal.submitBtn.disabled = false; }
        }

        // --- ORIGINAL APP LOGIC (ADAPTED) ---
        async function createNewUser() {
            const name = document.getElementById('new-user-name-input').value.trim();
            if (!name) { showModal("कृपया अपना नाम दर्ज करें।"); return; }
            const newUserId = crypto.randomUUID();
            // We associate the custom UUID with the Firebase UID here
            await setDoc(doc(db, "users", newUserId), { 
                name: name, 
                userId: newUserId, 
                authUid: currentUser.uid, // Store the auth UID
                createdAt: serverTimestamp() 
            });
            localStorage.setItem('arvindAppUserId', newUserId);
            await loadUserData(newUserId);
        }

        async function loginExistingUser() {
            const userId = document.getElementById('existing-user-id-input').value.trim();
            if (!userId) { showModal("कृपया अपनी आईडी दर्ज करें।"); return; }
            const userDoc = await getDoc(doc(db, "users", userId));
            if (!userDoc.exists()) { showModal("यह उपयोगकर्ता आईडी मौजूद नहीं है।"); return; }
            localStorage.setItem('arvindAppUserId', userId);
            await loadUserData(userId);
        }

        function loadMessages() {
            const chatMessages = document.getElementById('chat-messages');
            const q = query(collection(db, "chats"), orderBy("timestamp", "desc"), limit(50));
            unsubscribeChat = onSnapshot(q, (querySnapshot) => {
                chatMessages.innerHTML = "";
                querySnapshot.docs.reverse().forEach(doc => {
                    const msg = doc.data();
                    const bubble = document.createElement('div');
                    const isMe = msg.senderId === applicationUserId;
                    bubble.className = `p-3 rounded-xl max-w-xs ${isMe ? 'bg-indigo-500 text-white self-end' : 'bg-slate-200 self-start'}`;
                    bubble.innerHTML = `${!isMe ? `<div class="font-bold text-xs text-indigo-600">${msg.senderName}</div>` : ''}<div>${msg.text}</div>`;
                    chatMessages.appendChild(bubble);
                });
                if(chatMessages.scrollHeight > chatMessages.clientHeight) {
                  chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            });
        }

        async function sendMessage(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (text === "") return;
            input.value = "";
            await addDoc(collection(db, "chats"), { text: text, senderId: applicationUserId, senderName: currentUserName, timestamp: serverTimestamp() });
        }
        
        async function updateUserName() {
            const newName = document.getElementById('profile-name-input').value.trim();
            if (!newName) { showModal("नाम खाली नहीं हो सकता।"); return; }
            await updateDoc(doc(db, "users", applicationUserId), { name: newName });
            currentUserName = newName;
            document.getElementById('welcome-message').textContent = `नमस्ते, ${currentUserName}!`;
            showModal("नाम सफलतापूर्वक अपडेट किया गया!");
        }
        
        function handleLogout() {
            signOut(auth).then(() => {
                localStorage.removeItem('arvindAppUserId');
                currentUser = null;
                applicationUserId = null;
                window.location.reload();
            });
        }
        
        // --- EVENT LISTENERS ---
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('intro-screen').classList.add('active');
                setTimeout(initializeFirebase, 1500);
            }, 1000);
        });
        document.querySelectorAll('.back-btn').forEach(btn => btn.addEventListener('click', goBack));
        messageModal.okBtn.addEventListener('click', hideModals);

        document.getElementById('have-account-btn').addEventListener('click', () => showScreen('have-account-screen'));
        document.getElementById('new-user-btn').addEventListener('click', () => showScreen('new-user-screen'));
        document.getElementById('create-user-btn').addEventListener('click', createNewUser);
        document.getElementById('login-btn').addEventListener('click', loginExistingUser);
        document.getElementById('chat-form').addEventListener('submit', sendMessage);
        document.getElementById('copy-id-btn').addEventListener('click', () => {
            navigator.clipboard.writeText(applicationUserId).then(() => showModal("ID कॉपी हो गया!"));
        });
        document.getElementById('save-name-btn').addEventListener('click', updateUserName);
        document.getElementById('logout-btn').addEventListener('click', handleLogout);

        document.getElementById('nav-home').addEventListener('click', () => showScreen('home-screen', true));
        document.getElementById('nav-chat').addEventListener('click', () => showScreen('chat-screen', true));
        document.getElementById('nav-profile').addEventListener('click', () => {
            document.getElementById('display-user-id').textContent = applicationUserId;
            document.getElementById('profile-name-input').value = currentUserName;
            showScreen('profile-screen', true);
        });

        document.getElementById('prep-by-syllabus-btn').addEventListener('click', () => { populateSubjects(); showScreen('jee-prep-setup-screen'); });
        document.getElementById('daily-rank-test-btn').addEventListener('click', startDailyTest);
        document.getElementById('scoreboard-btn').addEventListener('click', loadScoreboard);
        document.getElementById('feedback-btn').addEventListener('click', openFeedbackModal);
        
        document.getElementById('generate-test-btn').addEventListener('click', async () => {
            const btn = document.getElementById('generate-test-btn');
            const subjects = [...document.querySelectorAll('input[name="subject"]:checked')].map(el => el.value);
            if (subjects.length === 0) {
                showModal("कृपया कम से कम एक विषय चुनें।");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div> Generating...`;

            const baseText = "आपका अभ्यास टेस्ट बना रहा हूँ...";
            showModal(baseText, "कृपया प्रतीक्षा करें");
            let seconds = 0;
            const modalTextEl = document.getElementById('message-modal-text');
            modalTextEl.innerHTML = `${baseText}<br><br>अनुमानित समय: ${seconds} सेकंड`;
            generationTimerInterval = setInterval(() => {
                seconds++;
                if(!modalContainer.classList.contains('hidden')) {
                    modalTextEl.innerHTML = `${baseText}<br><br>अनुमानित समय: ${seconds} सेकंड`;
                } else {
                    clearInterval(generationTimerInterval);
                }
            }, 1000);

            const examData = await generateTest(true);

            clearInterval(generationTimerInterval);
            btn.disabled = false;
            btn.textContent = "Generate Test";

            if (examData) {
                hideModals();
                startExam(examData);
            }
        });

        document.getElementById('submit-exam-btn').addEventListener('click', () => {
            if (currentExamData.type === 'daily') {
                showModal("क्या आप वाकई टेस्ट जमा करना चाहते हैं?", "Confirm Submission", () => submitExam());
            } else {
                submitExam();
            }
        });
        document.getElementById('back-to-home-btn').addEventListener('click', () => showScreen('home-screen', true));
        feedbackModal.cancelBtn.addEventListener('click', hideModals);
        feedbackModal.submitBtn.addEventListener('click', submitFeedback);
    </script>
</body>
</html>
