<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Future JEE Crackers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Base styles for the body and app wrapper */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e0f2f7; /* Lighter, more inviting background */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden; /* Prevent horizontal scrolling */
        }
        .app-wrapper {
            width: 100%;
            max-width: 42rem; /* Slightly wider for better content display */
            min-height: 100vh;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(0,0,0,0.1); /* More prominent shadow */
            border-radius: 1.5rem; /* Rounded corners for the entire app container */
            overflow: hidden; /* Ensures content stays within rounded corners */
        }
        /* Screen transitions */
        .screen {
            display: none;
            flex-direction: column;
            flex-grow: 1;
            width: 100%;
            animation: fadeInScale 0.6s ease-out forwards; /* Smoother animation */
        }
        .screen.active {
            display: flex;
        }
        /* Gradient text for titles */
        .gradient-text {
            background: linear-gradient(45deg, #6366f1, #ec4899); /* Deeper indigo to vibrant pink */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        /* Primary button styling */
        .button-primary {
            background-color: #6366f1; /* Tailwind indigo-500 */
            color: white;
            padding: 1rem 2rem; /* Larger padding */
            border-radius: 9999px; /* Fully rounded (pill shape) */
            font-weight: 700; /* Bolder text */
            transition: all 0.3s ease;
            box-shadow: 0 6px 12px rgba(99, 102, 241, 0.3); /* Shadow matching button color */
            letter-spacing: 0.025em; /* Slight letter spacing */
            text-transform: uppercase; /* Uppercase text */
        }
        .button-primary:hover:not(:disabled) {
            background-color: #4f46e5; /* Darker indigo on hover */
            transform: translateY(-3px); /* More pronounced lift effect */
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.4);
        }
        .button-primary:disabled {
            background-color: #a5b4fc;
            cursor: not-allowed;
            box-shadow: none;
        }
        /* Secondary button styling */
        .button-secondary {
            background-color: #e0e7ff; /* Lighter indigo background */
            color: #4f46e5; /* Indigo text */
            padding: 1rem 2rem;
            border-radius: 9999px;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .button-secondary:hover {
            background-color: #c7d2fe;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        /* Bottom navigation bar */
        .bottom-nav {
            display: flex;
            border-top: 1px solid #e5e7eb;
            background-color: #ffffff;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05); /* Shadow for depth */
            border-top-left-radius: 1.5rem; /* Match app wrapper radius */
            border-top-right-radius: 1.5rem;
        }
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 0.75rem 0;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s ease;
            border-top: 3px solid transparent;
            display: flex; /* For vertical alignment of icon and text */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem; /* Smaller text for nav items */
        }
        .nav-item.active {
            color: #6366f1; /* Active color */
            border-top-color: #6366f1;
            font-weight: 600;
        }
        .nav-item:hover {
            background-color: #f3f4f6; /* Lighter hover background */
        }
        .nav-item svg {
            margin: 0 auto 0.25rem;
            width: 1.75rem; /* Slightly larger icons */
            height: 1.75rem;
        }
        
        /* Modal styling */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7); /* Darker backdrop */
            z-index: 40;
            animation: fadeIn 0.3s ease-out;
        }
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95); /* Slightly smaller initially */
            z-index: 50;
            animation: modalPop 0.3s ease-out forwards; /* Pop animation */
            border-radius: 1.5rem; /* Rounded corners for modals */
            padding: 2.5rem; /* More padding */
        }
        /* Subject selection grid */
        .subject-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* Slightly wider columns */
            gap: 1.25rem; /* More spacing */
        }
        /* Exam question styling */
        .exam-question {
            scroll-margin-top: 80px;
            background-color: #ffffff;
            padding: 1.75rem; /* More padding */
            border-radius: 1.25rem; /* Rounded corners */
            box-shadow: 0 4px 10px rgba(0,0,0,0.08); /* Subtle shadow */
            transition: transform 0.2s ease-out;
        }
        .exam-question:hover {
            transform: translateY(-2px); /* Slight lift on hover */
        }

        /* Keyframe animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes modalPop {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }
        .animate-pulse-subtle {
            animation: pulse 2s infinite ease-in-out;
        }

        /* Custom styling for inputs and selects */
        input[type="text"], input[type="email"], input[type="password"], textarea, select {
            border: 1px solid #cbd5e1; /* slate-300 */
            border-radius: 0.75rem; /* rounded-lg */
            padding: 0.75rem 1rem; /* p-3 */
            width: 100%;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); /* subtle inner shadow */
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #6366f1; /* indigo-500 */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); /* focus ring */
        }

        /* Custom radio/checkbox styling */
        input[type="radio"], input[type="checkbox"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 1.25rem; /* h-5 w-5 */
            height: 1.25rem;
            border: 2px solid #9ca3af; /* gray-400 */
            border-radius: 0.375rem; /* rounded-md */
            background-color: #ffffff;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        input[type="radio"] {
            border-radius: 50%; /* fully rounded for radio */
        }
        input[type="radio"]:checked, input[type="checkbox"]:checked {
            background-color: #6366f1; /* indigo-500 */
            border-color: #6366f1;
        }
        input[type="radio"]:checked::before {
            content: '';
            display: block;
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 50%;
            background-color: white;
            margin: 3px; /* Center the dot */
        }
        input[type="checkbox"]:checked::before {
            content: '‚úî'; /* Checkmark for checkbox */
            display: block;
            color: white;
            font-size: 0.75rem;
            line-height: 1;
            text-align: center;
            margin-top: 1px;
        }
        
        /* Specific styling for subject selection labels */
        .subject-grid label {
            transition: all 0.2s ease;
            border: 2px solid #e2e8f0; /* slate-200 */
            border-radius: 1rem; /* More rounded */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .subject-grid label:hover {
            border-color: #a5b4fc; /* Light indigo on hover */
            transform: translateY(-1px);
        }
        .subject-grid label.has-[:checked]:bg-indigo-100 {
            background-color: #e0e7ff; /* Lighter indigo when checked */
            border-color: #6366f1; /* Stronger border when checked */
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.2);
        }

        /* Back button styling */
        .back-btn {
            background-color: #f1f5f9; /* slate-100 */
            color: #475569; /* slate-600 */
            border-radius: 9999px; /* fully rounded */
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        .back-btn:hover {
            background-color: #e2e8f0; /* slate-200 */
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Poll/Announcement Box */
        #poll-box {
            background-color: #eef2ff; /* Lightest indigo */
            border-left: 5px solid #6366f1; /* Stronger border */
            color: #4338ca; /* Darker indigo text */
            padding: 1.25rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            animation: fadeIn 0.5s ease-in-out;
        }
        #poll-box .vote-btn {
            background-color: #6366f1;
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 9999px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }
        #poll-box .vote-btn:hover:not(:disabled) {
            background-color: #4f46e5;
            transform: translateY(-2px);
        }
        #poll-box .vote-btn:disabled {
            background-color: #a5b4fc;
            cursor: not-allowed;
            opacity: 0.7;
        }
        #poll-box .vote-count {
            font-weight: 700;
            font-size: 1.25rem;
            color: #4f46e5;
        }
        #poll-box .vote-status-message {
            font-style: italic;
            color: #5a67d8;
            font-size: 0.9rem;
            margin-top: 0.75rem;
        }


        /* Scoreboard list items */
        #scoreboard-list div {
            border-radius: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }
        #scoreboard-list div:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #scoreboard-list div.bg-indigo-100 {
             background-color: #e0e7ff; /* Lighter indigo for 'You' */
             border-color: #6366f1;
        }

        /* Chat bubble styling */
        #chat-messages div {
            border-radius: 1.25rem; /* More rounded bubbles */
            padding: 0.85rem 1.25rem;
            max-width: 80%; /* Allow more space for messages */
            word-wrap: break-word; /* Ensure long words wrap */
        }
        #chat-messages div.bg-indigo-500 {
            background-color: #6366f1; /* Primary color for sent messages */
        }
        #chat-messages div.bg-slate-200 {
            background-color: #e2e8f0; /* Lighter background for received messages */
        }
        #chat-input {
            border-radius: 9999px; /* Pill shape for input */
            padding-left: 1.25rem;
            padding-right: 1.25rem;
        }
        #chat-form button {
            background-color: #6366f1;
            border-radius: 9999px;
            padding: 0.75rem; /* Larger send button */
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.3);
            transition: all 0.2s ease;
        }
        #chat-form button:hover {
            background-color: #4f46e5;
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(99, 102, 241, 0.4);
        }

        /* Countdown box for All India JEE+Advanced */
        .bg-amber-500 {
            background-color: #f59e0b; /* Tailwind amber-500 */
            box-shadow: 0 6px 12px rgba(245, 158, 11, 0.3);
            animation: pulse 2s infinite ease-in-out; /* Subtle pulse animation */
        }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <main class="flex-grow flex flex-col">
            <!-- Loading Screen -->
            <div id="loading-screen" class="screen active flex-col justify-center items-center p-8">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-indigo-600"></div>
                <h1 class="text-4xl font-bold mt-8 gradient-text">Future JEE Crackers</h1>
                <p class="text-slate-500 mt-3 text-lg">by ARVIND DARA BISHNOI</p>
            </div>

            <!-- Original Intro/Login Screens -->
            <div id="intro-screen" class="screen justify-center items-center p-8">
                <h1 class="text-6xl font-extrabold gradient-text text-center leading-tight">ARVIND DARA BISHNOI</h1>
                <p class="text-slate-600 text-center mt-4 text-lg">JEE ‡§Æ‡•á‡§Ç ‡§∏‡§´‡§≤‡§§‡§æ ‡§ï‡§æ ‡§Ü‡§™‡§ï‡§æ ‡§Æ‡§æ‡§∞‡•ç‡§ó ‡§Ø‡§π‡§æ‡§Å ‡§∏‡•á ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã‡§§‡§æ ‡§π‡•à‡•§</p>
            </div>
            <div id="main-screen" class="screen flex-col justify-center items-center p-8 space-y-6">
                <h2 class="text-4xl font-bold text-gray-800 mb-8">‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à! üëã</h2>
                <button id="have-account-btn" class="button-primary w-full max-w-sm">‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ‡§ñ‡§æ‡§§‡§æ (‡§ê‡§™ ‡§Ü‡§à‡§°‡•Ä)</button>
                <button id="email-signup-btn" class="button-secondary w-full max-w-sm">‡§∏‡§æ‡§á‡§® ‡§Ö‡§™ ‡§ï‡§∞‡•á‡§Ç (‡§à‡§Æ‡•á‡§≤/‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°)</button>
                <button id="email-login-btn" class="button-secondary w-full max-w-sm">‡§≤‡•â‡§ó ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç (‡§à‡§Æ‡•á‡§≤/‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°)</button>
                <button id="continue-as-guest-btn" class="button-secondary w-full max-w-sm">‡§ó‡•á‡§∏‡•ç‡§ü ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡•á‡§Ç</button>
            </div>
            <div id="new-user-screen" class="screen flex-col justify-center items-center p-8 space-y-6">
                <button class="back-btn absolute top-6 left-6 p-3 rounded-full hover:bg-slate-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                <h2 class="text-3xl font-bold text-gray-800">‡§Ü‡§™‡§ï‡§æ ‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?</h2>
                <input type="text" id="new-user-name-input" placeholder="‡§Ö‡§™‡§®‡§æ ‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç" class="p-4 border rounded-xl w-full max-w-sm text-lg">
                <button id="create-guest-user-btn" class="button-primary w-full max-w-sm">‡§ó‡•á‡§∏‡•ç‡§ü ‡§ñ‡§æ‡§§‡§æ ‡§¨‡§®‡§æ‡§è‡§Å</button>
            </div>
            <div id="email-signup-screen" class="screen flex-col justify-center items-center p-8 space-y-6">
                <button class="back-btn absolute top-6 left-6 p-3 rounded-full hover:bg-slate-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                <h2 class="text-3xl font-bold text-gray-800">‡§ñ‡§æ‡§§‡§æ ‡§¨‡§®‡§æ‡§è‡§Å</h2>
                <input type="text" id="signup-name-input" placeholder="‡§Ö‡§™‡§®‡§æ ‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç" class="p-4 border rounded-xl w-full max-w-sm text-lg">
                <input type="email" id="signup-email-input" placeholder="‡§à‡§Æ‡•á‡§≤ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç" class="p-4 border rounded-xl w-full max-w-sm text-lg">
                <input type="password" id="signup-password-input" placeholder="‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç" class="p-4 border rounded-xl w-full max-w-sm text-lg">
                <button id="signup-btn" class="button-primary w-full max-w-sm">‡§∏‡§æ‡§á‡§® ‡§Ö‡§™ ‡§ï‡§∞‡•á‡§Ç</button>
            </div>
             <div id="email-login-screen" class="screen flex-col justify-center items-center p-8 space-y-6">
                <button class="back-btn absolute top-6 left-6 p-3 rounded-full hover:bg-slate-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                <h2 class="text-3xl font-bold text-gray-800">‡§≤‡•â‡§ó ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç</h2>
                <input type="email" id="login-email-input" placeholder="‡§à‡§Æ‡•á‡§≤ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç" class="p-4 border rounded-xl w-full max-w-sm text-lg">
                <input type="password" id="login-password-input" placeholder="‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç" class="p-4 border rounded-xl w-full max-w-sm text-lg">
                <button id="email-login-submit-btn" class="button-primary w-full max-w-sm">‡§≤‡•â‡§ó ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç</button>
            </div>
            <div id="have-account-screen" class="screen flex-col justify-center items-center p-8 space-y-6">
                <button class="back-btn absolute top-6 left-6 p-3 rounded-full hover:bg-slate-200"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                <h2 class="text-3xl font-bold text-gray-800">‡§Ö‡§™‡§®‡•Ä ‡§Ü‡§à‡§°‡•Ä ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç</h2>
                <input type="text" id="existing-user-id-input" placeholder="‡§Ö‡§™‡§®‡•Ä ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§Ü‡§à‡§°‡•Ä ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç" class="p-4 border rounded-xl w-full max-w-sm text-lg">
                <button id="login-btn" class="button-primary w-full max-w-sm">‡§≤‡•â‡§ó ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç</button>
            </div>

            <!-- Home Screen -->
            <div id="home-screen" class="screen flex-col p-6 md:p-8 space-y-6 overflow-y-auto">
                <header class="pb-4 border-b border-slate-100 flex items-center justify-between">
                    <div>
                        <h1 id="welcome-message" class="text-3xl font-bold text-slate-800">‡§®‡§Æ‡§∏‡•ç‡§§‡•á!</h1>
                        <p class="text-slate-500 text-lg mt-1">JEE ‡§ú‡•Ä‡§§‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•à‡§Ç?</p>
                    </div>
                    <i class="fas fa-graduation-cap text-5xl gradient-text opacity-80"></i>
                </header>
                <!-- Poll Box (formerly Announcement Box) -->
                <div id="poll-box" class="bg-indigo-50 border-l-4 border-indigo-500 text-indigo-800 p-4 rounded-r-lg shadow-sm hidden">
                    <p class="font-bold mb-2">‡§Ü‡§ú ‡§ï‡§æ ‡§™‡•ã‡§≤</p>
                    <p id="poll-question-text" class="text-lg mb-4"></p>
                    <div class="flex justify-around items-center gap-4">
                        <button id="thumbs-up-btn" class="vote-btn flex-1 bg-green-500 hover:bg-green-600">
                            <i class="fas fa-thumbs-up"></i> <span id="thumbs-up-count">0</span>
                        </button>
                        <button id="thumbs-down-btn" class="vote-btn flex-1 bg-red-500 hover:bg-red-600">
                            <i class="fas fa-thumbs-down"></i> <span id="thumbs-down-count">0</span>
                        </button>
                    </div>
                    <p id="vote-status-message" class="vote-status-message text-center"></p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5 pt-4">
                    <button id="prep-by-syllabus-btn" class="bg-indigo-600 text-white p-7 rounded-2xl shadow-xl hover:bg-indigo-700 transition text-left space-y-2 transform hover:scale-105 flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold">JEE ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§§‡•à‡§Ø‡§æ‡§∞‡•Ä</h2>
                            <p class="text-indigo-200 text-base">‡§™‡§æ‡§†‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ü‡•á‡§∏‡•ç‡§ü‡•§</p>
                        </div>
                        <i class="fas fa-book-open text-4xl opacity-70"></i>
                    </button>
                    <button id="daily-rank-test-btn" class="bg-pink-600 text-white p-7 rounded-2xl shadow-xl hover:bg-pink-700 transition text-left space-y-2 transform hover:scale-105 flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold">‡§¶‡•à‡§®‡§ø‡§ï JEE ‡§∞‡•à‡§Ç‡§ï ‡§∂‡•ç‡§∞‡•É‡§Ç‡§ñ‡§≤‡§æ</h2>
                            <p class="text-pink-200 text-base">‡§è‡§ï ‡§≤‡§æ‡§á‡§µ ‡§ü‡•á‡§∏‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§™‡•ç‡§∞‡§§‡§ø‡§∏‡•ç‡§™‡§∞‡•ç‡§ß‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§</p>
                        </div>
                        <i class="fas fa-trophy text-4xl opacity-70"></i>
                    </button>
                    <button id="scoreboard-btn" class="bg-green-600 text-white p-7 rounded-2xl shadow-xl hover:bg-green-700 transition text-left space-y-2 transform hover:scale-105 flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold">‡§¶‡•à‡§®‡§ø‡§ï ‡§∏‡•ç‡§ï‡•ã‡§∞ ‡§¨‡•ã‡§∞‡•ç‡§°</h2>
                            <p class="text-green-200 text-base">‡§∞‡•à‡§Ç‡§ï ‡§î‡§∞ ‡§∂‡•Ä‡§∞‡•ç‡§∑ ‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§® ‡§ï‡§∞‡§®‡•á ‡§µ‡§æ‡§≤‡•ã‡§Ç ‡§ï‡•Ä ‡§ú‡§æ‡§Å‡§ö ‡§ï‡§∞‡•á‡§Ç‡•§</p>
                        </div>
                        <i class="fas fa-clipboard-list text-4xl opacity-70"></i>
                    </button>
                    <div class="bg-amber-500 text-white p-7 rounded-2xl shadow-xl text-left space-y-2 animate-pulse-subtle flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold">‡§Ö‡§ñ‡§ø‡§≤ ‡§≠‡§æ‡§∞‡§§‡•Ä‡§Ø JEE+‡§è‡§°‡§µ‡§æ‡§Ç‡§∏‡•ç‡§°</h2>
                            <p id="all-india-test-countdown" class="text-amber-200 text-base">7 ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã‡§ó‡§æ!</p>
                        </div>
                        <i class="fas fa-star text-4xl opacity-70"></i>
                    </div>
                </div>
                <div class="pt-6">
                    <button id="feedback-btn" class="w-full text-center py-4 bg-slate-200 text-slate-700 rounded-xl hover:bg-slate-300 transition font-semibold text-lg shadow-md flex items-center justify-center gap-3">
                        <i class="fas fa-comment-dots"></i>
                        <span>‡§Ü‡§™ ‡§ï‡•å‡§® ‡§∏‡•Ä ‡§®‡§à ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ‡§è‡§Å ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?</span>
                    </button>
                </div>
            </div>
            
            <!-- Chat Screen -->
            <div id="chat-screen" class="screen flex-col">
                <header class="p-4 border-b border-slate-200 font-bold text-xl text-center text-slate-700 bg-white shadow-sm">‡§µ‡•à‡§∂‡•ç‡§µ‡§ø‡§ï ‡§ö‡•à‡§ü</header>
                <!-- Changed flex-col-reverse to flex-col to display messages from bottom to top -->
                <div id="chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto flex flex-col"></div>
                <form id="chat-form" class="p-4 border-t border-slate-200 flex gap-3 bg-white">
                    <input type="text" id="chat-input" placeholder="‡§è‡§ï ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç..." class="flex-grow p-3 border rounded-full text-base">
                    <button type="submit" class="bg-indigo-600 text-white rounded-full p-3 flex-shrink-0 shadow-md hover:bg-indigo-700 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009.894 15V4.106A1 1 0 0010.894 2.553z" /></svg></button>
                </form>
            </div>

            <!-- Profile Screen -->
            <div id="profile-screen" class="screen flex-col p-6 space-y-6 overflow-y-auto">
                 <h2 class="text-4xl font-bold text-gray-800 gradient-text mb-4">‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤</h2>
                <div class="bg-slate-100 p-5 rounded-xl shadow-sm">
                    <p class="font-semibold text-gray-700 mb-2 text-lg">‡§Ü‡§™‡§ï‡•Ä ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§Ü‡§à‡§°‡•Ä:</p>
                    <div class="flex items-center justify-between">
                        <p id="display-user-id" class="font-mono text-gray-600 break-all text-sm bg-slate-200 p-2 rounded-md flex-grow mr-2"></p>
                        <button id="copy-id-btn" class="px-4 py-2 bg-gray-200 text-gray-700 text-sm rounded-lg hover:bg-gray-300 transition">‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç</button>
                    </div>
                </div>
                <div class="bg-slate-100 p-5 rounded-xl shadow-sm">
                    <p class="font-semibold text-gray-700 mb-2 text-lg">‡§Ü‡§™‡§ï‡§æ ‡§®‡§æ‡§Æ:</p>
                    <input type="text" id="profile-name-input" class="p-3 border rounded-lg w-full mb-3 text-base">
                    <button id="save-name-btn" class="button-primary w-full text-base py-3">‡§®‡§æ‡§Æ ‡§∏‡§π‡•á‡§ú‡•á‡§Ç</button>
                </div>
                <div class="bg-slate-100 p-5 rounded-xl shadow-sm">
                    <p class="font-semibold text-gray-700 mb-2 text-lg">‡§≠‡§æ‡§∑‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç:</p>
                    <select id="language-select" class="w-full p-3 border rounded-lg bg-white text-base">
                        <option value="english">English</option>
                        <option value="hindi" selected>‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
                    </select>
                </div>
                <a href="http://www.youtube.com/@RAVI..BHAI_0029" target="_blank" class="button-secondary w-full text-center text-lg py-4">‡§ö‡•à‡§®‡§≤ ‡§¶‡•á‡§ñ‡•á‡§Ç</a>
                <button id="logout-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-xl shadow-md text-lg">‡§≤‡•â‡§ó ‡§Ü‡§â‡§ü</button>
            </div>

            <!-- JEE Screens -->
            <div id="jee-prep-setup-screen" class="screen flex-col p-6 md:p-8 space-y-6 overflow-y-auto">
                <header class="flex items-center pb-4 border-b border-slate-100">
                    <button class="back-btn p-3 rounded-full hover:bg-slate-200 mr-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                    <h1 class="text-3xl font-bold">‡§Ö‡§™‡§®‡§æ ‡§ü‡•á‡§∏‡•ç‡§ü ‡§¨‡§®‡§æ‡§è‡§Å</h1>
                </header>
                <div class="space-y-8 pt-4">
                    <div>
                        <h3 class="font-semibold mb-3 text-xl">1. ‡§ï‡§ï‡•ç‡§∑‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç</h3>
                        <select id="class-select" class="w-full p-3 border rounded-lg bg-white text-base"><option value="11">‡§ï‡§ï‡•ç‡§∑‡§æ 11</option><option value="12">‡§ï‡§ï‡•ç‡§∑‡§æ 12</option><option value="11,12" selected>‡§™‡•Ç‡§∞‡§æ ‡§™‡§æ‡§†‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ (11‡§µ‡•Ä‡§Ç + 12‡§µ‡•Ä‡§Ç)</option></select>
                    </div>
                    <div>
                        <h3 class="font-semibold mb-3 text-xl">2. ‡§µ‡§ø‡§∑‡§Ø ‡§ö‡•Å‡§®‡•á‡§Ç</h3>
                        <div id="subject-selection" class="subject-grid"></div>
                    </div>
                    <div>
                        <h3 class="font-semibold mb-3 text-xl">3. ‡§ï‡§†‡§ø‡§®‡§æ‡§à ‡§ö‡•Å‡§®‡•á‡§Ç</h3>
                        <div class="flex flex-wrap gap-4">
                            <label class="flex-1 min-w-[120px] flex items-center p-3 border rounded-lg bg-white cursor-pointer has-[:checked]:bg-indigo-100 has-[:checked]:border-indigo-500">
                                <input type="radio" name="difficulty" value="Basic" class="mr-2 h-5 w-5 rounded-full text-indigo-600 focus:ring-indigo-500">
                                <span class="font-semibold text-base">‡§Æ‡•Ç‡§≤</span>
                            </label>
                            <label class="flex-1 min-w-[120px] flex items-center p-3 border rounded-lg bg-white cursor-pointer has-[:checked]:bg-indigo-100 has-[:checked]:border-indigo-500">
                                <input type="radio" name="difficulty" value="JEE Main" class="mr-2 h-5 w-5 rounded-full text-indigo-600 focus:ring-indigo-500" checked>
                                <span class="font-semibold text-base">JEE ‡§Æ‡•Å‡§ñ‡•ç‡§Ø</span>
                            </label>
                            <label class="flex-1 min-w-[120px] flex items-center p-3 border rounded-lg bg-white cursor-pointer has-[:checked]:bg-indigo-100 has-[:checked]:border-indigo-500">
                                <input type="radio" name="difficulty" value="JEE Advanced" class="mr-2 h-5 w-5 rounded-full text-indigo-600 focus:ring-indigo-500">
                                <span class="font-semibold text-base">JEE ‡§è‡§°‡§µ‡§æ‡§Ç‡§∏‡•ç‡§°</span>
                            </label>
                        </div>
                    </div>
                    <button id="generate-test-btn" class="w-full button-primary py-4 font-bold shadow-lg text-xl">‡§ü‡•á‡§∏‡•ç‡§ü ‡§¨‡§®‡§æ‡§è‡§Å</button>
                </div>
            </div>
            <div id="exam-screen" class="screen flex-col">
                <header class="sticky top-0 bg-white shadow-md z-10 p-4 flex justify-between items-center border-b border-slate-200">
                    <h1 id="exam-title" class="text-xl font-bold text-slate-800">‡§ü‡•á‡§∏‡•ç‡§ü ‡§™‡•ç‡§∞‡§ó‡§§‡§ø ‡§™‡§∞ ‡§π‡•à</h1>
                    <div id="exam-timer" class="font-bold text-2xl text-indigo-600 bg-indigo-50 px-4 py-2 rounded-full shadow-inner">03:00:00</div>
                </header>
                <div id="exam-content" class="p-4 md:p-6 space-y-8 overflow-y-auto flex-grow bg-slate-50"></div>
                <footer class="sticky bottom-0 bg-white p-4 border-t border-slate-200 shadow-md">
                    <button id="submit-exam-btn" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700 transition text-lg shadow-lg">‡§ü‡•á‡§∏‡•ç‡§ü ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç</button>
                </footer>
            </div>
            <div id="result-screen" class="screen flex-col justify-center items-center p-8">
                 <h1 class="text-5xl font-bold mb-6 gradient-text">‡§ü‡•á‡§∏‡•ç‡§ü ‡§™‡•Ç‡§∞‡§æ ‡§π‡•Å‡§Ü! üéâ</h1>
                 <div class="text-center bg-slate-100 p-10 rounded-3xl shadow-2xl w-full max-w-md">
                    <p class="text-xl text-slate-600 mb-2">‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§ï‡•ã‡§∞</p>
                    <p id="result-score" class="text-8xl font-extrabold my-4 text-indigo-600">--/300</p>
                    <div class="grid grid-cols-3 gap-4 text-center mt-6">
                        <div><p class="font-semibold text-slate-700">‡§∏‡§π‡•Ä</p><p id="result-correct" class="text-3xl font-bold text-green-600">0</p></div>
                        <div><p class="font-semibold text-slate-700">‡§ó‡§≤‡§§</p><p id="result-incorrect" class="text-3xl font-bold text-red-600">0</p></div>
                        <div><p class="font-semibold text-slate-700">‡§Ö‡§®‡•Å‡§§‡•ç‡§§‡§∞‡§ø‡§§</p><p id="result-unanswered" class="text-3xl font-bold text-slate-500">0</p></div>
                    </div>
                 </div>
                 <button id="back-to-home-btn" class="mt-12 button-primary py-4 px-10 text-xl shadow-lg">‡§π‡•ã‡§Æ ‡§™‡§∞ ‡§µ‡§æ‡§™‡§∏ ‡§ú‡§æ‡§è‡§Å</button>
            </div>
            <div id="scoreboard-screen" class="screen flex-col p-6 md:p-8">
                <header class="flex items-center mb-6 pb-4 border-b border-slate-100">
                    <button class="back-btn p-3 rounded-full hover:bg-slate-200 mr-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                    <h1 class="text-3xl font-bold">‡§¶‡•à‡§®‡§ø‡§ï ‡§ü‡•á‡§∏‡•ç‡§ü ‡§∏‡•ç‡§ï‡•ã‡§∞‡§¨‡•ã‡§∞‡•ç‡§°</h1>
                </header>
                <div id="scoreboard-info" class="text-center text-slate-500 p-3 bg-slate-100 rounded-lg mb-6 text-sm shadow-sm">‡§ü‡•á‡§∏‡•ç‡§ü ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á 2 ‡§ò‡§Ç‡§ü‡•á ‡§¨‡§æ‡§¶ ‡§∏‡•ç‡§ï‡•ã‡§∞ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§ø‡§è ‡§ú‡§æ‡§§‡•á ‡§π‡•à‡§Ç‡•§</div>
                <div id="scoreboard-list" class="space-y-3 overflow-y-auto flex-grow"><p class="text-center text-slate-500 p-8">‡§∏‡•ç‡§ï‡•ã‡§∞‡§¨‡•ã‡§∞‡•ç‡§° ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</p></div>
            </div>

        </main>
        
        <!-- Bottom Nav -->
        <nav id="bottom-nav" class="bottom-nav hidden">
            <div id="nav-home" class="nav-item active">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                <span>‡§π‡•ã‡§Æ</span>
            </div>
            <div id="nav-chat" class="nav-item">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                <span>‡§ö‡•à‡§ü</span>
            </div>
            <div id="nav-profile" class="nav-item">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                <span>‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤</span>
            </div>
        </nav>
        <footer id="app-footer" class="text-center p-3 text-xs text-slate-400 opacity-60 hidden bg-white">Arvind Dara Bishnoi ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§®‡§ø‡§∞‡•ç‡§Æ‡§ø‡§§</footer>
    </div>
    
    <!-- Modals Container -->
    <div id="modal-container" class="hidden">
        <div class="modal-backdrop"></div>
        <div id="message-modal" class="modal bg-white rounded-2xl shadow-2xl p-8 w-11/12 max-w-sm text-center">
            <h3 id="message-modal-title" class="text-2xl font-bold mb-4 text-slate-800">‡§Ö‡§≤‡§∞‡•ç‡§ü</h3>
            <p id="message-modal-text" class="text-slate-600 mb-6 text-lg"></p>
            <button id="message-modal-ok-btn" class="w-full button-primary py-3 text-lg">‡§†‡•Ä‡§ï ‡§π‡•à</button>
        </div>
        <div id="feedback-modal" class="modal bg-white rounded-2xl shadow-2xl p-8 w-11/12 max-w-md hidden">
             <h3 class="text-2xl font-bold mb-4 text-slate-800">‡§Ü‡§™‡§ï‡•Ä ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ</h3>
             <p class="text-slate-600 mb-4 text-base">‡§Ü‡§™ ‡§ï‡•å‡§® ‡§∏‡•Ä ‡§®‡§à ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ‡§è‡§Å ‡§Ø‡§æ ‡§∏‡•Å‡§ß‡§æ‡§∞ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? (‡§™‡•ç‡§∞‡§§‡§ø ‡§¶‡§ø‡§® ‡§è‡§ï ‡§¨‡§æ‡§∞)</p>
             <textarea id="feedback-input" class="w-full p-3 border rounded-lg h-32 text-base" placeholder="‡§Ø‡§π‡§æ‡§Å ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç..."></textarea>
             <div class="flex gap-4 mt-6">
                <button id="feedback-cancel-btn" class="flex-1 bg-slate-200 py-3 rounded-lg text-lg font-semibold hover:bg-slate-300 transition">‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
                <button id="feedback-submit-btn" class="flex-1 button-primary py-3 text-lg">‡§ú‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Debugging: Script parsing started.
        console.log("Script parsing started."); 
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, updateDoc, query, where, onSnapshot, addDoc, getDocs, orderBy, serverTimestamp, limit, increment } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // --- CONFIG & GLOBAL VARS ---
        // ‡§®‡•ã‡§ü: ‡§µ‡§æ‡§∏‡•ç‡§§‡§µ‡§ø‡§ï ‡§¶‡•Å‡§®‡§ø‡§Ø‡§æ ‡§ï‡•á ‡§Ö‡§®‡•Å‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó‡•ã‡§Ç ‡§Æ‡•á‡§Ç, API ‡§ï‡•Å‡§Ç‡§ú‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§∏‡•Ä‡§ß‡•á ‡§ï‡•ã‡§° ‡§Æ‡•á‡§Ç ‡§π‡§æ‡§∞‡•ç‡§°‡§ï‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è‡•§
        // ‡§â‡§®‡•ç‡§π‡•á‡§Ç ‡§∏‡§∞‡•ç‡§µ‡§∞-‡§∏‡§æ‡§á‡§° ‡§Ø‡§æ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§µ‡§æ‡§§‡§æ‡§µ‡§∞‡§£ ‡§ö‡§∞ ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è‡•§
        const GEMINI_API_KEY = "AIzaSyCsxr987Sb41cI13aJ0PyfOYxCuNWH3p-0"; // API key will be provided by the environment
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
        const firebaseConfig = {
            apiKey: "AIzaSyC3faZ16ZTsIUBEfI9dl55RnDklVeWIHts",
            authDomain: "arvind-dara.firebaseapp.com",
            projectId: "arvind-dara",
            storageBucket: "arvind-dara.appspot.com",
            messagingSenderId: "341922555843",
            appId: "1:341922555843:web:cefd0e44e5d8afae4fbf76"
        };
        // Firebase ‡§ï‡•â‡§®‡•ç‡§´‡§º‡§ø‡§ó‡§∞‡•á‡§∂‡§® ‡§ï‡§æ ‡§Ö‡§Ç‡§§

        let app, db, auth, currentUser, userData, applicationUserId, currentUserName;
        let screenHistory = [];
        let unsubscribeChat = null;
        let currentExamData = null;
        let examTimerInterval = null;
        let generationTimerInterval = null; // AI ‡§ú‡§®‡§∞‡•á‡§∂‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ü‡§æ‡§á‡§Æ‡§∞
        let tabSwitchCount = 0;
        let modalOkCallback = null;
        let currentPollId = null; // ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§™‡•ã‡§≤ ‡§ï‡•Ä ‡§Ü‡§à‡§°‡•Ä ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è
        let remainingExamTime = 0; // ‡§≤‡§ó‡§æ‡§§‡§æ‡§∞ ‡§ü‡§æ‡§á‡§Æ‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ

        // --- DOM ELEMENTS ---
        const allScreens = document.querySelectorAll('.screen');
        const bottomNav = document.getElementById('bottom-nav');
        const appFooter = document.getElementById('app-footer');
        const modalContainer = document.getElementById('modal-container');
        const messageModal = { el: document.getElementById('message-modal'), title: document.getElementById('message-modal-title'), text: document.getElementById('message-modal-text'), okBtn: document.getElementById('message-modal-ok-btn') };
        const feedbackModal = { el: document.getElementById('feedback-modal'), input: document.getElementById('feedback-input'), submitBtn: document.getElementById('feedback-submit-btn'), cancelBtn: document.getElementById('feedback-cancel-btn') };
        
        // ‡§™‡•ã‡§≤ ‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§§‡§§‡•ç‡§µ
        const pollBox = document.getElementById('poll-box');
        const pollQuestionText = document.getElementById('poll-question-text');
        const thumbsUpBtn = document.getElementById('thumbs-up-btn');
        const thumbsDownBtn = document.getElementById('thumbs-down-btn');
        const thumbsUpCount = document.getElementById('thumbs-up-count');
        const thumbsDownCount = document.getElementById('thumbs-down-count');
        const voteStatusMessage = document.getElementById('vote-status-message');

        // --- CORE APP FLOW ---
        function showScreen(screenId, isNav = false) {
            console.log(`‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§¶‡§ø‡§ñ‡§æ ‡§∞‡§π‡§æ ‡§π‡•à: ${screenId}`);
            const currentActive = document.querySelector('.screen.active');
            if (currentActive && currentActive.id !== screenId && !isNav) {
                screenHistory.push(currentActive.id);
            }
            if (isNav) screenHistory = [];

            allScreens.forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');

            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            let associatedNav = document.getElementById(`nav-${screenId.replace('-screen', '')}`);
            if(associatedNav) associatedNav.classList.add('active');
            else document.getElementById('nav-home').classList.add('active');

            if (screenId === 'chat-screen' && !unsubscribeChat) loadMessages();
            if (screenId !== 'chat-screen' && unsubscribeChat) {
                unsubscribeChat();
                unsubscribeChat = null;
            }

            // ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§™‡§∞ ‡§® ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§ü‡§æ‡§á‡§Æ‡§∞ ‡§∞‡•ã‡§ï‡•á‡§Ç
            if (screenId !== 'exam-screen' && examTimerInterval) {
                clearInterval(examTimerInterval);
                examTimerInterval = null;
            }
            // ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§™‡§∞ ‡§≤‡•å‡§ü‡§®‡•á ‡§™‡§∞ ‡§ü‡§æ‡§á‡§Æ‡§∞ ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç
            else if (screenId === 'exam-screen' && remainingExamTime > 0 && !examTimerInterval) {
                startTimer(remainingExamTime);
            }
        }

        function goBack() {
            if (screenHistory.length > 0) {
                const lastScreenId = screenHistory.pop();
                showScreen(lastScreenId, true);
            } else {
                showScreen('main-screen', true); // ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§ñ‡§æ‡§≤‡•Ä ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§™‡§∞ ‡§µ‡§æ‡§™‡§∏ ‡§ú‡§æ‡§è‡§Å
            }
        }

        function showModal(content, title = "‡§Ö‡§≤‡§∞‡•ç‡§ü", onOk) { // ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§ï‡•ã ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤‡§æ ‡§ó‡§Ø‡§æ
            console.log(`‡§Æ‡•ã‡§°‡§≤ ‡§¶‡§ø‡§ñ‡§æ ‡§∞‡§π‡§æ ‡§π‡•à: ${title} - ${content}`);
            messageModal.title.textContent = title;
            messageModal.text.innerHTML = content;
            modalContainer.classList.remove('hidden');
            messageModal.el.classList.remove('hidden');
            feedbackModal.el.classList.add('hidden');
            modalOkCallback = onOk;
        }
        function hideModals() { 
            console.log("‡§Æ‡•ã‡§°‡§≤ ‡§õ‡§ø‡§™‡§æ ‡§∞‡§π‡§æ ‡§π‡•à‡•§");
            modalContainer.classList.add('hidden'); 
            if (typeof modalOkCallback === 'function') {
                const callback = modalOkCallback;
                modalOkCallback = null;
                callback();
            }
        }

        // --- FIREBASE & AUTH ---
        // ‡§¨‡•á‡§π‡§§‡§∞ ‡§°‡•Ä‡§¨‡§ó‡§ø‡§Ç‡§ó ‡§ï‡•á ‡§≤‡§ø‡§è ‡§µ‡•à‡§∂‡•ç‡§µ‡§ø‡§ï ‡§Ö‡§®‡§π‡•à‡§Ç‡§°‡§≤‡•ç‡§° ‡§™‡•ç‡§∞‡•â‡§Æ‡§ø‡§∏ ‡§∞‡§ø‡§ú‡•á‡§ï‡•ç‡§∂‡§® ‡§≤‡§ø‡§∏‡§®‡§∞
        window.addEventListener('unhandledrejection', (event) => {
            console.error('‡§Ö‡§®‡§π‡•à‡§Ç‡§°‡§≤‡•ç‡§° ‡§™‡•ç‡§∞‡•â‡§Æ‡§ø‡§∏ ‡§∞‡§ø‡§ú‡•á‡§ï‡•ç‡§∂‡§®:', event.promise, '‡§ï‡§æ‡§∞‡§£:', event.reason);
            showModal(`‡§è‡§ï ‡§Ö‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡§æ‡§∂‡§ø‡§§ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à: ${event.reason.message || event.reason}. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§Ç‡§∏‡•ã‡§≤ ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§`, "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø"); // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶
        });

        async function initializeFirebase() {
            console.log("Firebase ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à...");
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                // onAuthStateChanged ‡§≤‡§ø‡§∏‡§®‡§∞ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó Firebase ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡•Ä‡§ï‡§∞‡§£ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§Æ‡•á‡§Ç ‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§® ‡§ï‡•ã ‡§ü‡•ç‡§∞‡•à‡§ï ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à‡•§
                // ‡§Ø‡§π ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§ï‡§ø ‡§π‡§Æ ‡§π‡§Æ‡•á‡§∂‡§æ ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§Æ‡•á‡§Ç ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§ø‡§§ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡•ã ‡§ú‡§æ‡§®‡§§‡•á ‡§π‡•à‡§Ç‡•§
                onAuthStateChanged(auth, async (user) => {
                    console.log("onAuthStateChanged ‡§´‡§æ‡§Ø‡§∞ ‡§π‡•Å‡§Ü‡•§ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ:", user ? user.uid : "null");
                    if (user) {
                        currentUser = user; // ‡§µ‡•à‡§∂‡•ç‡§µ‡§ø‡§ï currentUser ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
                        await findAndLinkAppUserByAuthUid(currentUser.uid); // ‡§π‡§Æ‡•á‡§∂‡§æ ‡§ê‡§™ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡•ã ‡§ñ‡•ã‡§ú‡§®‡•á/‡§≤‡§ø‡§Ç‡§ï ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç
                    } else {
                        console.log("‡§ï‡•ã‡§à Firebase ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡§π‡•Ä‡§Ç, ‡§ó‡•Å‡§Æ‡§®‡§æ‡§Æ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§∏‡§æ‡§á‡§® ‡§á‡§® ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à‡•§");
                        // ‡§Ø‡§¶‡§ø ‡§ï‡•ã‡§à Firebase ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§§‡•ã ‡§ó‡•Å‡§Æ‡§®‡§æ‡§Æ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§∏‡§æ‡§á‡§® ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç‡•§ onAuthStateChanged ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§´‡§æ‡§Ø‡§∞ ‡§π‡•ã‡§ó‡§æ‡•§
                        await signInAnonymously(auth);
                    }
                });
            } catch (error) { 
                console.error("Firebase ‡§™‡•ç‡§∞‡§æ‡§∞‡§Ç‡§≠ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error); 
                showModal("‡§ê‡§™ ‡§∂‡•Å‡§∞‡•Ç ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§æ‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∞‡•Ä‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç‡•§", "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø"); // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ
            }
        }
        
        async function findAndLinkAppUserByAuthUid(authUid) {
            console.log("authUid ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§ê‡§™ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡•ã ‡§ñ‡•ã‡§ú‡§®‡•á ‡§î‡§∞ ‡§≤‡§ø‡§Ç‡§ï ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à:", authUid);
            const storedAppUserId = localStorage.getItem('arvindAppUserId');
            let userDocFound = false;

            if (storedAppUserId) {
                const userRef = doc(db, "users", storedAppUserId);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists() && userSnap.data().authUid === authUid) {
                    userData = userSnap.data();
                    applicationUserId = storedAppUserId;
                    currentUserName = userData.name || "‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ";
                    userDocFound = true;
                    console.log("‡§≠‡§Ç‡§°‡§æ‡§∞‡§ø‡§§ ‡§Ü‡§à‡§°‡•Ä ‡§î‡§∞ ‡§Æ‡§ø‡§≤‡§æ‡§® authUid ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§ê‡§™ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§Æ‡§ø‡§≤‡§æ‡•§");
                } else {
                    console.warn("‡§≠‡§Ç‡§°‡§æ‡§∞‡§ø‡§§ ‡§ê‡§™‡§Ø‡•Ç‡§ú‡§∞‡§Ü‡§à‡§°‡•Ä ‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§Ø‡§æ ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® authUid ‡§∏‡•á ‡§Æ‡•á‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§ñ‡§æ ‡§∞‡§π‡§æ ‡§π‡•à‡•§ ‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§≠‡§Ç‡§°‡§æ‡§∞‡§£ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à‡•§");
                    localStorage.removeItem('arvindAppUserId');
                }
            }

            if (!userDocFound) {
                // ‡§Ø‡§¶‡§ø ‡§≠‡§Ç‡§°‡§æ‡§∞‡§ø‡§§ ‡§Ü‡§à‡§°‡•Ä ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ, ‡§§‡•ã Firestore ‡§Æ‡•á‡§Ç authUid ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§ñ‡•ã‡§ú‡•á‡§Ç
                const q = query(collection(db, "users"), where("authUid", "==", authUid), limit(1));
                const querySnap = await getDocs(q);

                if (!querySnap.empty) {
                    const userDoc = querySnap.docs[0];
                    userData = userDoc.data();
                    applicationUserId = userDoc.id;
                    currentUserName = userData.name || "‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ";
                    localStorage.setItem('arvindAppUserId', applicationUserId); // ‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§≠‡§Ç‡§°‡§æ‡§∞‡§£ ‡§Æ‡•á‡§Ç ‡§∏‡§π‡•á‡§ú‡•á‡§Ç
                    userDocFound = true;
                    console.log("Firestore ‡§Æ‡•á‡§Ç authUid ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§ê‡§™ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§Æ‡§ø‡§≤‡§æ‡•§");
                }
            }

            if (userDocFound) {
                setupAppForUser();
            } else {
                // ‡§á‡§∏ Firebase Auth UID ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ‡§ê‡§™ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§
                // ‡§á‡§∏‡§ï‡§æ ‡§Æ‡§§‡§≤‡§¨ ‡§π‡•à ‡§ï‡§ø ‡§Ø‡§π ‡§è‡§ï ‡§®‡§Ø‡§æ Firebase Auth ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§π‡•à (‡§è‡§ï ‡§®‡§Ø‡§æ ‡§à‡§Æ‡•á‡§≤ ‡§∏‡§æ‡§á‡§®‡§Ö‡§™, ‡§Ø‡§æ ‡§è‡§ï ‡§®‡§Ø‡§æ ‡§ó‡•Å‡§Æ‡§®‡§æ‡§Æ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à)‡•§
                console.log("‡§á‡§∏ Firebase Auth UID ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ‡§ê‡§™ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§™‡§∞ ‡§∞‡•Ä‡§°‡§æ‡§Ø‡§∞‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à‡•§");
                showScreen('main-screen');
            }
        }


        async function setupAppForUser() {
            console.log("‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ê‡§™ ‡§∏‡•á‡§ü‡§Ö‡§™ ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à:", currentUserName);
            document.getElementById('welcome-message').textContent = `‡§®‡§Æ‡§∏‡•ç‡§§‡•á, ${currentUserName}!`;
            try {
                await loadPoll();
                console.log("‡§™‡•ã‡§≤ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§≤‡•ã‡§° ‡§π‡•Å‡§Ü‡•§");
            } catch (error) {
                console.error("setupAppForUser ‡§Æ‡•á‡§Ç loadPoll ‡§ï‡•á ‡§¶‡•å‡§∞‡§æ‡§® ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error);
                showModal("‡§™‡•ã‡§≤ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§", "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø");
            }
            bottomNav.classList.remove('hidden');
            appFooter.classList.remove('hidden');
            console.log("‡§π‡•ã‡§Æ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§¶‡§ø‡§ñ‡§æ ‡§∞‡§π‡§æ ‡§π‡•à‡•§");
            showScreen('home-screen', true);
        }
        
        // --- NEW JEE APP LOGIC ---
        function getTodayDateString() {
            return new Date().toISOString().split('T')[0]; // YYYY-MM-DD in UTC
        }
        
        async function loadPoll() {
            console.log("‡§™‡•ã‡§≤ ‡§≤‡•ã‡§° ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à...");
            try {
                const q = query(collection(db, "polls"), orderBy("createdAt", "desc"), limit(1));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    const poll = querySnapshot.docs[0].data();
                    currentPollId = querySnapshot.docs[0].id; // ‡§™‡•ã‡§≤ ‡§Ü‡§à‡§°‡•Ä ‡§∏‡•ç‡§ü‡•ã‡§∞ ‡§ï‡§∞‡•á‡§Ç
                    pollQuestionText.textContent = poll.questionText;
                    thumbsUpCount.textContent = poll.thumbsUpCount || 0;
                    thumbsDownCount.textContent = poll.thumbsDownCount || 0;
                    pollBox.classList.remove('hidden');

                    // ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç ‡§ï‡§ø ‡§ï‡•ç‡§Ø‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡•á ‡§™‡§π‡§≤‡•á ‡§π‡•Ä ‡§µ‡•ã‡§ü ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§π‡•à
                    const userRef = doc(db, "users", applicationUserId);
                    const userSnap = await getDoc(userRef);
                    if (userSnap.exists()) {
                        const userVotedPolls = userSnap.data().votedPolls || {};
                        if (userVotedPolls[currentPollId]) {
                            thumbsUpBtn.disabled = true;
                            thumbsDownBtn.disabled = true;
                            voteStatusMessage.textContent = "‡§Ü‡§™‡§®‡•á ‡§á‡§∏ ‡§™‡•ã‡§≤ ‡§™‡§∞ ‡§™‡§π‡§≤‡•á ‡§π‡•Ä ‡§µ‡•ã‡§ü ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§π‡•à‡•§";
                        } else {
                            thumbsUpBtn.disabled = false;
                            thumbsDownBtn.disabled = false;
                            voteStatusMessage.textContent = "‡§µ‡•ã‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§•‡§Æ‡•ç‡§∏ ‡§Ö‡§™ ‡§Ø‡§æ ‡§•‡§Æ‡•ç‡§∏ ‡§°‡§æ‡§â‡§® ‡§¶‡§¨‡§æ‡§è‡§Å‡•§";
                        }
                    }
                } else {
                    pollBox.classList.add('hidden'); // ‡§Ø‡§¶‡§ø ‡§ï‡•ã‡§à ‡§™‡•ã‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‡§§‡•ã ‡§õ‡§ø‡§™‡§æ‡§è‡§Å
                    console.log("‡§ï‡•ã‡§à ‡§™‡•ã‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ, ‡§™‡•ã‡§≤ ‡§¨‡•â‡§ï‡•ç‡§∏ ‡§õ‡§ø‡§™‡§æ ‡§∞‡§π‡§æ ‡§π‡•à‡•§");
                }
            } catch (error) { 
                console.error("‡§™‡•ã‡§≤ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error); 
            }
        }

        async function submitVote(voteType) {
            if (!currentPollId || !applicationUserId) {
                showModal("‡§™‡•ã‡§≤ ‡§Ø‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§Ü‡§à‡§°‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§");
                return;
            }

            thumbsUpBtn.disabled = true;
            thumbsDownBtn.disabled = true;

            try {
                const pollRef = doc(db, "polls", currentPollId);
                const userRef = doc(db, "users", applicationUserId);

                // ‡§∞‡•á‡§∏ ‡§ï‡§Ç‡§°‡•Ä‡§∂‡§® ‡§ï‡•á ‡§Æ‡§æ‡§Æ‡§≤‡•á ‡§Æ‡•á‡§Ç ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç (‡§π‡§æ‡§≤‡§æ‡§Ç‡§ï‡§ø Firestore ‡§®‡§ø‡§Ø‡§Æ ‡§á‡§∏‡•á ‡§∞‡•ã‡§ï‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è)
                const userSnap = await getDoc(userRef);
                const userVotedPolls = userSnap.data().votedPolls || {};
                if (userVotedPolls[currentPollId]) {
                    showModal("‡§Ü‡§™‡§®‡•á ‡§á‡§∏ ‡§™‡•ã‡§≤ ‡§™‡§∞ ‡§™‡§π‡§≤‡•á ‡§π‡•Ä ‡§µ‡•ã‡§ü ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§π‡•à‡•§", "‡§µ‡•ã‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ");
                    voteStatusMessage.textContent = "‡§Ü‡§™‡§®‡•á ‡§á‡§∏ ‡§™‡•ã‡§≤ ‡§™‡§∞ ‡§™‡§π‡§≤‡•á ‡§π‡•Ä ‡§µ‡•ã‡§ü ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§π‡•à‡•§";
                    return;
                }

                // ‡§™‡•ã‡§≤ ‡§ï‡§æ‡§â‡§Ç‡§ü ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
                await updateDoc(pollRef, {
                    [`${voteType}Count`]: increment(1)
                });

                // ‡§á‡§∏ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•ã‡§≤ ‡§ï‡•ã ‡§µ‡•ã‡§ü ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§ö‡§ø‡§π‡•ç‡§®‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç
                await updateDoc(userRef, {
                    [`votedPolls.${currentPollId}`]: true
                });

                // UI ‡§ï‡•ã ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
                if (voteType === 'thumbsUp') {
                    thumbsUpCount.textContent = parseInt(thumbsUpCount.textContent) + 1;
                } else {
                    thumbsDownCount.textContent = parseInt(thumbsDownCount.textContent) + 1;
                }
                voteStatusMessage.textContent = "‡§Ü‡§™‡§ï‡§æ ‡§µ‡•ã‡§ü ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞ ‡§≤‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à!";
                showModal("‡§Ü‡§™‡§ï‡§æ ‡§µ‡•ã‡§ü ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞ ‡§≤‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à!", "‡§µ‡•ã‡§ü ‡§∏‡§´‡§≤");

            } catch (error) {
                console.error("‡§µ‡•ã‡§ü ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error);
                showModal("‡§µ‡•ã‡§ü ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§", "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø");
                thumbsUpBtn.disabled = false; // ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§∏‡§ï‡•ç‡§∑‡§Æ ‡§ï‡§∞‡•á‡§Ç
                thumbsDownBtn.disabled = false;
                voteStatusMessage.textContent = "‡§µ‡•ã‡§ü ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§";
            }
        }


        function populateSubjects() {
            const container = document.getElementById('subject-selection');
            container.innerHTML = '';
            ["‡§≠‡•å‡§§‡§ø‡§ï‡•Ä (Physics)", "‡§∞‡§∏‡§æ‡§Ø‡§® ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§® (Chemistry)", "‡§ó‡§£‡§ø‡§§ (Maths)"].forEach(subject => {
                const label = document.createElement('label');
                label.className = "flex items-center p-3 border rounded-lg bg-white cursor-pointer has-[:checked]:bg-indigo-100 has-[:checked]:border-indigo-500";
                label.innerHTML = `<input type="checkbox" name="subject" value="${subject}" class="mr-3 h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500"><span class="font-semibold">${subject}</span>`;
                container.appendChild(label);
            });
        }

        async function generateTest(isPractice = true) {
            const subjects = [...document.querySelectorAll('input[name="subject"]:checked')].map(el => el.value);
            
            const difficulty = isPractice ? document.querySelector('input[name="difficulty"]:checked').value : 'JEE Main';
            const classSelection = isPractice ? document.getElementById('class-select').value : '11,12';
            const questionCount = isPractice ? (25 * subjects.length) : 75;
            const subjectString = isPractice ? subjects.join(', ') : "Physics, Chemistry, and Maths";

            const prompt = `Generate a ${difficulty} level practice test for JEE Main in HINDI language. Class: ${classSelection}. Subjects: ${subjectString}. Total Questions: ${questionCount}. For each question, provide: a question text, four options (A, B, C, D), the correct option letter, and a brief explanation in Hindi. Ensure questions are unique.`;
            const schema = { type: "OBJECT", properties: { "questions": { "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "subject": {"type": "STRING"}, "question": {"type": "STRING"}, "options": { "type": "OBJECT", "properties": { "A": {"type": "STRING"}, "B": {"type": "STRING"}, "C": {"type": "STRING"}, "D": {"type": "STRING"} } }, "correct_answer": {"type": "STRING"}, "explanation": {"type": "STRING"} } } } } };

            const btn = isPractice ? document.getElementById('generate-test-btn') : null;
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div> ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...`; // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶
            }

            try {
                const response = await fetch(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema } }) });
                if (!response.ok) throw new Error(`API ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${response.statusText}`);
                const result = await response.json();
                const parsedData = JSON.parse(result.candidates[0].content.parts[0].text);
                
                if (isPractice) {
                    currentExamData = parsedData;
                    currentExamData.type = 'practice';
                }
                return parsedData;
            } catch (error) { 
                console.error("‡§ü‡•á‡§∏‡•ç‡§ü ‡§ú‡§®‡§∞‡•á‡§∂‡§® ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error); 
                showModal("‡§ü‡•á‡§∏‡•ç‡§ü ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§", "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø"); // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶
                return null;
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = "‡§ü‡•á‡§∏‡•ç‡§ü ‡§¨‡§®‡§æ‡§è‡§Å";
                }
            }
        }

        function startExam(examData) {
            document.getElementById('exam-content').innerHTML = '';
            document.getElementById('exam-title').textContent = examData.type === 'daily' ? '‡§¶‡•à‡§®‡§ø‡§ï ‡§∞‡•à‡§Ç‡§ï ‡§ü‡•á‡§∏‡•ç‡§ü' : '‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ü‡•á‡§∏‡•ç‡§ü';
            examData.questions.forEach((q, i) => {
                const qEl = document.createElement('div');
                qEl.className = 'exam-question bg-white p-6 rounded-lg shadow-md';
                qEl.id = `question-${i}`;
                qEl.innerHTML = `<p class="font-bold text-lg mb-4">‡§™‡•ç‡§∞‡§∂‡•ç‡§® ${i + 1} (${q.subject})</p><p class="mb-6 text-lg">${q.question}</p><div class="space-y-3">${Object.entries(q.options).map(([k, v]) => `<label class="flex items-center p-3 border rounded-lg cursor-pointer has-[:checked]:bg-indigo-100"><input type="radio" name="q${i}" value="${k}" class="mr-4 h-5 w-5"><span><b>${k}.</b> ${v}</span></label>`).join('')}</div>`;
                document.getElementById('exam-content').appendChild(qEl);
            });
            showScreen('exam-screen');
            startTimer(180 * 60); // 3 ‡§ò‡§Ç‡§ü‡•á
            if (examData.type === 'daily') {
                tabSwitchCount = 0;
                document.addEventListener('visibilitychange', handleVisibilityChange);
            }
        }

        function handleVisibilityChange() {
            if (document.visibilityState === 'hidden' && document.getElementById('exam-screen').classList.contains('active') && currentExamData.type === 'daily') {
                tabSwitchCount++;
                showModal(`‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä: ‡§ü‡•à‡§¨ ‡§¨‡§¶‡§≤‡§®‡§æ ‡§™‡•ç‡§∞‡§§‡§ø‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§π‡•à‡•§ ‡§Ü‡§™‡§ï‡§æ ‡§∞‡•à‡§Ç‡§ï ‡§™‡•ç‡§∞‡§≠‡§æ‡§µ‡§ø‡§§ ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§ ‡§∏‡•ç‡§µ‡§ø‡§ö: ${tabSwitchCount}`, "‡§ß‡•ã‡§ñ‡§æ‡§ß‡§°‡§º‡•Ä ‡§ï‡•Ä ‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä"); // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶
                if (tabSwitchCount >= 3) {
                    showModal("‡§Ü‡§™‡§®‡•á 3 ‡§∏‡•á ‡§Ö‡§ß‡§ø‡§ï ‡§¨‡§æ‡§∞ ‡§ü‡•à‡§¨ ‡§¨‡§¶‡§≤‡§æ ‡§π‡•à‡•§ ‡§Ü‡§™‡§ï‡§æ ‡§ü‡•á‡§∏‡•ç‡§ü ‡§Ö‡§™‡§®‡•á ‡§Ü‡§™ ‡§ú‡§Æ‡§æ ‡§π‡•ã ‡§ú‡§æ‡§è‡§ó‡§æ‡•§", "‡§ü‡•á‡§∏‡•ç‡§ü ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§", () => submitExam(true)); // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶
                }
            }
        }

        function startTimer(duration) {
            clearInterval(examTimerInterval);
            remainingExamTime = duration;
            updateTimerDisplay();
            examTimerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            remainingExamTime--;
            updateTimerDisplay();
            if (remainingExamTime <= 0) {
                clearInterval(examTimerInterval);
                showModal("‡§∏‡§Æ‡§Ø ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§!", "‡§∏‡§Æ‡§Ø ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§", () => submitExam()); // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶
            }
        }

        function updateTimerDisplay() {
            const timerEl = document.getElementById('exam-timer');
            if (!timerEl) return; // ‡§Ø‡§¶‡§ø ‡§ü‡§æ‡§á‡§Æ‡§∞ ‡§§‡§§‡•ç‡§µ ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à
            
            let h = Math.floor(remainingExamTime / 3600);
            let m = Math.floor((remainingExamTime % 3600) / 60);
            let s = remainingExamTime % 60;
            timerEl.textContent = `${h<10?'0'+h:h}:${m<10?'0'+m:m}:${s<10?'0'+s:s}`;
        }

        async function submitExam(cheated = false) {
            clearInterval(examTimerInterval);
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            let correct = 0, incorrect = 0, unanswered = 0;
            currentExamData.questions.forEach((q, i) => {
                const sel = document.querySelector(`input[name="q${i}"]:checked`);
                if (!sel) { unanswered++; }
                else if (sel.value === q.correct_answer) { correct++; } 
                else { incorrect++; }
            });
            const score = (correct * 4) - (incorrect * 1);

            if (currentExamData.type === 'daily') {
                const finalScore = cheated ? 0 : score;
                try {
                    const dailyTestId = getTodayDateString();
                    await addDoc(collection(db, "dailyTestSubmissions"), { 
                        userId: currentUser.uid, // Firebase Auth UID ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç
                        userName: currentUserName, 
                        score: finalScore, 
                        cheated, 
                        submittedAt: serverTimestamp(),
                        paperDate: dailyTestId
                    });
                    showModal(`‡§ü‡•á‡§∏‡•ç‡§ü ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ú‡§Æ‡§æ ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§ ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§ï‡•ã‡§∞ ${finalScore} ‡§π‡•à‡•§ ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ 2 ‡§ò‡§Ç‡§ü‡•á ‡§¨‡§æ‡§¶ ‡§∏‡•ç‡§ï‡•ã‡§∞‡§¨‡•ã‡§∞‡•ç‡§° ‡§™‡§∞ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ‡•§`, "‡§∏‡§´‡§≤‡§§‡§æ", () => showScreen('home-screen', true)); // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶
                } catch (e) { console.error(e); showModal("‡§ü‡•á‡§∏‡•ç‡§ü ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§", "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø"); }
            } else {
                document.getElementById('result-score').textContent = `${score}/${currentExamData.questions.length * 4}`;
                document.getElementById('result-correct').textContent = correct;
                document.getElementById('result-incorrect').textContent = incorrect;
                document.getElementById('result-unanswered').textContent = unanswered;
                showScreen('result-screen');
            }
        }

        async function startDailyTest() {
            const btn = document.getElementById('daily-rank-test-btn');
            btn.disabled = true;
            
            const today = getTodayDateString();
            
            const submissionsRef = collection(db, "dailyTestSubmissions");
            // Firebase Auth UID ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ç‡§µ‡•á‡§∞‡•Ä ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç
            const q = query(submissionsRef, where("userId", "==", currentUser.uid), where("paperDate", "==", today));
            const submissionSnap = await getDocs(q);

            if (!submissionSnap.empty) {
                showModal("‡§Ü‡§™ ‡§Ü‡§ú ‡§ï‡§æ ‡§ü‡•á‡§∏‡•ç‡§ü ‡§™‡§π‡§≤‡•á ‡§π‡•Ä ‡§¶‡•á ‡§ö‡•Å‡§ï‡•á ‡§π‡•à‡§Ç‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§≤ ‡§´‡§ø‡§∞ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§", "‡§™‡§π‡§≤‡•á ‡§π‡•Ä ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ"); // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶
                btn.disabled = false;
                return;
            }

            showModal("‡§Ü‡§ú ‡§ï‡§æ ‡§ü‡•á‡§∏‡•ç‡§ü ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...", "‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç"); // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶
            const paperRef = doc(db, "dailyPaper", today);
            const paperSnap = await getDoc(paperRef);
            let paperData;

            if (paperSnap.exists()) {
                paperData = paperSnap.data();
            } else {
                const baseText = "‡§Ü‡§ú ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§®‡§Ø‡§æ ‡§ü‡•á‡§∏‡•ç‡§ü ‡§™‡•á‡§™‡§∞ ‡§¨‡§®‡§æ ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Å...";
                showModal(baseText, "‡§ü‡•á‡§∏‡•ç‡§ü ‡§¨‡§®‡§æ ‡§∞‡§π‡§æ ‡§π‡•à"); // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶
                let seconds = 0;
                const modalTextEl = document.getElementById('message-modal-text');
                modalTextEl.innerHTML = `${baseText}<br><br>‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®‡§ø‡§§ ‡§∏‡§Æ‡§Ø: ${seconds} ‡§∏‡•á‡§ï‡§Ç‡§°`; // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶
                generationTimerInterval = setInterval(() => {
                    seconds++;
                    if(!modalContainer.classList.contains('hidden')) {
                       modalTextEl.innerHTML = `${baseText}<br><br>‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®‡§ø‡§§ ‡§∏‡§Æ‡§Ø: ${seconds} ‡§∏‡•á‡§ï‡§Ç‡§°`; // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶
                    } else {
                        clearInterval(generationTimerInterval);
                    }
                }, 1000);

                paperData = await generateTest(false);
                
                clearInterval(generationTimerInterval);

                if (paperData) {
                    await setDoc(paperRef, { ...paperData, createdAt: serverTimestamp() });
                } else {
                    showModal("‡§Ü‡§ú ‡§ï‡§æ ‡§ü‡•á‡§∏‡•ç‡§ü ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§", "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø"); // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶
                    btn.disabled = false;
                    return;
                }
            }
            
            showModal("‡§ü‡•á‡§∏‡•ç‡§ü ‡§è‡§ï ‡§∏‡§Æ‡§Ø-‡§¨‡§¶‡•ç‡§ß ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§π‡•à‡•§ ‡§ü‡•à‡§¨ ‡§¨‡§¶‡§≤‡§®‡•á ‡§™‡§∞ ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§ï‡•ã‡§∞ 0 ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•à‡§Ç?", "‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä", () => { // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶
                hideModals();
                currentExamData = paperData;
                currentExamData.type = 'daily';
                startExam(currentExamData);
            });
            btn.disabled = false;
        }
        
        async function loadScoreboard() {
            showScreen('scoreboard-screen');
            const listEl = document.getElementById('scoreboard-list');
            listEl.innerHTML = `<p class="text-center p-8">‡§∏‡•ç‡§ï‡•ã‡§∞‡§¨‡•ã‡§∞‡•ç‡§° ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</p>`; // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶
            try {
                const today = getTodayDateString();
                // Firestore ‡§∏‡•á ‡§ï‡•á‡§µ‡§≤ ‡§Ü‡§ú ‡§ï‡•á ‡§∏‡§¨‡§Æ‡§ø‡§∂‡§® ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç‡•§
                // 'orderBy' ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à ‡§§‡§æ‡§ï‡§ø ‡§á‡§Ç‡§°‡•á‡§ï‡•ç‡§∏ ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§∏‡•á ‡§¨‡§ö‡§æ ‡§ú‡§æ ‡§∏‡§ï‡•á‡•§
                const q = query(collection(db, "dailyTestSubmissions"), where("paperDate", "==", today));
                const snap = await getDocs(q);
                if (snap.empty) { 
                    listEl.innerHTML = `<p class="text-center p-8">‡§Ü‡§ú ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§à ‡§∏‡§¨‡§Æ‡§ø‡§∂‡§® ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</p>`; // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶
                    return; 
                }

                const twoHoursAgo = new Date(Date.now() - 2 * 60 * 60 * 1000);
                let scoresToShow = [];
                
                snap.docs.forEach(docSnap => {
                    const data = docSnap.data();
                    if (data.submittedAt && data.submittedAt.toDate) {
                        const submissionTime = data.submittedAt.toDate();
                        // ‡§ï‡•ç‡§≤‡§æ‡§á‡§Ç‡§ü-‡§∏‡§æ‡§á‡§° ‡§™‡§∞ 2 ‡§ò‡§Ç‡§ü‡•á ‡§∏‡•á ‡§Ö‡§ß‡§ø‡§ï ‡§™‡•Å‡§∞‡§æ‡§®‡•á ‡§∏‡§¨‡§Æ‡§ø‡§∂‡§® ‡§ï‡•ã ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§ï‡§∞‡•á‡§Ç
                        if (submissionTime < twoHoursAgo) {
                            scoresToShow.push(data);
                        }
                    }
                });

                // ‡§∏‡•ç‡§ï‡•ã‡§∞ ‡§ï‡•á ‡§Ü‡§ß‡§æ‡§∞ ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§æ‡§á‡§Ç‡§ü-‡§∏‡§æ‡§á‡§° ‡§™‡§∞ ‡§∏‡•â‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç
                scoresToShow.sort((a, b) => b.score - a.score);

                if (scoresToShow.length === 0) {
                    listEl.innerHTML = `<p class="text-center p-8">‡§Ö‡§≠‡•Ä ‡§§‡§ï ‡§ï‡•ã‡§à ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§ò‡•ã‡§∑‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü ‡§π‡•à‡•§ ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§ü‡•á‡§∏‡•ç‡§ü ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á 2 ‡§ò‡§Ç‡§ü‡•á ‡§¨‡§æ‡§¶ ‡§¶‡§ø‡§ñ‡§æ‡§è ‡§ú‡§æ‡§§‡•á ‡§π‡•à‡§Ç‡•§</p>`; // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶
                    return;
                }
                
                listEl.innerHTML = '';
                scoresToShow.forEach((data, i) => {
                    // Firebase Auth UID ‡§ï‡•á ‡§≤‡§ø‡§è ‡§§‡•Å‡§≤‡§®‡§æ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç
                    const isMe = data.userId === currentUser.uid;
                    const itemEl = document.createElement('div');
                    itemEl.className = `flex items-center p-4 rounded-lg ${isMe ? 'bg-indigo-100 border-2 border-indigo-500' : 'bg-slate-100'}`;
                    itemEl.innerHTML = `<span class="font-bold w-12 text-lg">${i + 1}.</span><span class="flex-grow font-semibold">${data.userName} ${isMe ? '(‡§Ü‡§™)' : ''} ${data.cheated ? '<span class=\"text-red-500 font-normal\">(‡§ß‡•ã‡§ñ‡§æ‡§ß‡§°‡§º‡•Ä)</span>' : ''}</span><span class="font-bold text-xl text-indigo-600">${data.score}</span>`; // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶
                    listEl.appendChild(itemEl);
                });
            } catch (error) { 
                console.error("‡§∏‡•ç‡§ï‡•ã‡§∞‡§¨‡•ã‡§∞‡•ç‡§° ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error); 
                listEl.innerHTML = `<p class="text-center text-red-500 p-8">‡§∏‡•ç‡§ï‡•ã‡§∞‡§¨‡•ã‡§∞‡•ç‡§° ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§æ‡•§</p>`; // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶
            }
        }

        async function openFeedbackModal() {
            const userDoc = await getDoc(doc(db, "users", applicationUserId));
            const lastFeedback = userDoc.data().lastFeedbackTimestamp;
            if (lastFeedback && (new Date() - lastFeedback.toDate()) / (1000 * 3600) < 24) {
                showModal("‡§Ü‡§™ ‡§™‡•ç‡§∞‡§§‡§ø‡§¶‡§ø‡§® ‡§ï‡•á‡§µ‡§≤ ‡§è‡§ï ‡§¨‡§æ‡§∞ ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§ú‡§Æ‡§æ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§", "‡§ï‡•Ç‡§≤‡§°‡§æ‡§â‡§®"); return; // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶
            }
            feedbackModal.input.value = '';
            modalContainer.classList.remove('hidden');
            feedbackModal.el.classList.remove('hidden');
            messageModal.el.classList.add('hidden');
        }

        async function submitFeedback() {
            const text = feedbackModal.input.value.trim();
            if (text.length < 10) { showModal("‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§ß‡§ø‡§ï ‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§ ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç‡•§", "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø"); return; } // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ
            feedbackModal.submitBtn.disabled = true;
            try {
                await addDoc(collection(db, "feedback"), { 
                    userId: currentUser.uid, // Firebase Auth UID ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç
                    userName: currentUserName, 
                    feedback: text, 
                    createdAt: serverTimestamp() 
                });
                await updateDoc(doc(db, "users", applicationUserId), { lastFeedbackTimestamp: serverTimestamp() });
                hideModals();
                showModal("‡§Ü‡§™‡§ï‡•Ä ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶!", "‡§∏‡§´‡§≤‡§§‡§æ"); // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶
            } catch (error) { console.error(error); showModal("‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§", "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø"); // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ
            } finally { feedbackModal.submitBtn.disabled = false; }
        }

        // --- AUTHENTICATION LOGIC ---

        // ‡§ó‡•á‡§∏‡•ç‡§ü (‡§ó‡•Å‡§Æ‡§®‡§æ‡§Æ) ‡§∏‡§æ‡§á‡§®-‡§á‡§® ‡§î‡§∞ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§®‡§ø‡§∞‡•ç‡§Æ‡§æ‡§£ ‡§ï‡•ã ‡§∏‡§Ç‡§≠‡§æ‡§≤‡§§‡§æ ‡§π‡•à
        async function handleGuestSignIn() {
            const name = document.getElementById('new-user-name-input').value.trim();
            if (!name) { showModal("‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§", "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø"); return; }

            // ‡§Ø‡§¶‡§ø ‡§ï‡•ã‡§à ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® Firebase ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§§‡•ã ‡§ó‡•Å‡§Æ‡§®‡§æ‡§Æ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§∏‡§æ‡§á‡§® ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç
            if (!auth.currentUser) {
                console.log("handleGuestSignIn: ‡§ï‡•ã‡§à ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® Firebase ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡§π‡•Ä‡§Ç, ‡§ó‡•Å‡§Æ‡§®‡§æ‡§Æ ‡§∏‡§æ‡§á‡§®-‡§á‡§® ‡§ï‡§æ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à‡•§");
                try {
                    await signInAnonymously(auth);
                    // onAuthStateChanged ‡§ï‡•ã ‡§®‡§è ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡•ã ‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•Å‡§õ ‡§∏‡§Æ‡§Ø ‡§¶‡•á‡§Ç
                    await new Promise(resolve => setTimeout(resolve, 500)); 
                } catch (anonError) {
                    console.error("‡§ó‡•á‡§∏‡•ç‡§ü ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ó‡•Å‡§Æ‡§®‡§æ‡§Æ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§∏‡§æ‡§á‡§® ‡§á‡§® ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", anonError);
                    showModal("‡§ó‡•á‡§∏‡•ç‡§ü ‡§ñ‡§æ‡§§‡§æ ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡•Ä‡§ï‡§∞‡§£ ‡§µ‡§ø‡§´‡§≤‡•§", "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø");
                    return;
                }
            }

            // ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø Firebase ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§π‡•à
            if (!auth.currentUser || !auth.currentUser.uid) {
                console.error("handleGuestSignIn: auth.currentUser ‡§Ø‡§æ ‡§á‡§∏‡§ï‡§æ UID ‡§∏‡§æ‡§á‡§®-‡§á‡§® ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§≠‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§");
                showModal("‡§ó‡•á‡§∏‡•ç‡§ü ‡§ñ‡§æ‡§§‡§æ ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡•Ä‡§ï‡§∞‡§£ ‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§", "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø");
                return;
            }

            console.log("Firebase UID ‡§ï‡•á ‡§∏‡§æ‡§• ‡§ó‡•á‡§∏‡•ç‡§ü ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡§æ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à:", auth.currentUser.uid);
            try {
                const newAppUserId = crypto.randomUUID();
                const userDocRef = doc(db, "users", newAppUserId);

                await setDoc(userDocRef, {
                    name: name,
                    userId: newAppUserId,
                    authUid: auth.currentUser.uid, // Firebase UID ‡§∏‡•á ‡§≤‡§ø‡§Ç‡§ï ‡§ï‡§∞‡•á‡§Ç
                    createdAt: serverTimestamp(),
                    lastActive: serverTimestamp(),
                    authType: 'anonymous' // ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡•Ä‡§ï‡§∞‡§£ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
                });
                
                localStorage.setItem('arvindAppUserId', newAppUserId);
                // ‡§∏‡•Ä‡§ß‡•á ‡§µ‡•à‡§∂‡•ç‡§µ‡§ø‡§ï ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§°‡•á‡§ü‡§æ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
                applicationUserId = newAppUserId;
                currentUserName = name;
                userData = { name: name, userId: newAppUserId, authUid: auth.currentUser.uid, authType: 'anonymous' };
                setupAppForUser(); // ‡§ê‡§™ ‡§∏‡•á‡§ü‡§Ö‡§™ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§ó‡•á ‡§¨‡§¢‡§º‡•á‡§Ç
            } catch (error) {
                console.error("Firestore ‡§Æ‡•á‡§Ç ‡§ó‡•á‡§∏‡•ç‡§ü ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error);
                showModal("‡§ó‡•á‡§∏‡•ç‡§ü ‡§ñ‡§æ‡§§‡§æ ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§", "‡§ñ‡§æ‡§§‡§æ ‡§®‡§ø‡§∞‡•ç‡§Æ‡§æ‡§£ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø");
            }
        }

        // ‡§à‡§Æ‡•á‡§≤/‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§∏‡§æ‡§á‡§®‡§Ö‡§™ ‡§î‡§∞ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§®‡§ø‡§∞‡•ç‡§Æ‡§æ‡§£ ‡§ï‡•ã ‡§∏‡§Ç‡§≠‡§æ‡§≤‡§§‡§æ ‡§π‡•à
        async function handleEmailSignup() {
            const name = document.getElementById('signup-name-input').value.trim();
            const email = document.getElementById('signup-email-input').value.trim();
            const password = document.getElementById('signup-password-input').value.trim();

            if (!name || !email || !password) {
                showModal("‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§≠‡•Ä ‡§´‡§º‡•Ä‡§≤‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç‡•§", "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø");
                return;
            }
            if (password.length < 6) {
                showModal("‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ 6 ‡§µ‡§∞‡•ç‡§£‡•ã‡§Ç ‡§ï‡§æ ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è‡•§", "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø");
                return;
            }

            try {
                // Firebase ‡§ï‡•á ‡§∏‡§æ‡§• ‡§®‡§Ø‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§¨‡§®‡§æ‡§è‡§Å
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const firebaseUser = userCredential.user;

                // Firebase ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§®‡§Ø‡§æ ‡§ê‡§™-‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ID ‡§¨‡§®‡§æ‡§è‡§Å
                const newAppUserId = crypto.randomUUID();
                const userDocRef = doc(db, "users", newAppUserId);

                await setDoc(userDocRef, {
                    name: name,
                    email: email, // ‡§à‡§Æ‡•á‡§≤ ‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π‡•Ä‡§§ ‡§ï‡§∞‡•á‡§Ç (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï, ‡§≤‡•á‡§ï‡§ø‡§® ‡§â‡§™‡§Ø‡•ã‡§ó‡•Ä ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à)
                    userId: newAppUserId,
                    authUid: firebaseUser.uid, // Firebase UID ‡§∏‡•á ‡§≤‡§ø‡§Ç‡§ï ‡§ï‡§∞‡•á‡§Ç
                    createdAt: serverTimestamp(),
                    lastActive: serverTimestamp(),
                    authType: 'email' // ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡•Ä‡§ï‡§∞‡§£ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
                });

                localStorage.setItem('arvindAppUserId', newAppUserId);
                // ‡§∏‡•Ä‡§ß‡•á ‡§µ‡•à‡§∂‡•ç‡§µ‡§ø‡§ï ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§°‡•á‡§ü‡§æ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
                currentUser = firebaseUser; // ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø currentUser ‡§Ö‡§™‡§°‡•á‡§ü‡•á‡§° ‡§π‡•à
                applicationUserId = newAppUserId;
                currentUserName = name;
                userData = { name: name, email: email, userId: newAppUserId, authUid: firebaseUser.uid, authType: 'email' };
                
                showModal("‡§ñ‡§æ‡§§‡§æ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§¨‡§®‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ!", "‡§∏‡§´‡§≤‡§§‡§æ", () => {
                    setupAppForUser(); // ‡§ê‡§™ ‡§∏‡•á‡§ü‡§Ö‡§™ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§ó‡•á ‡§¨‡§¢‡§º‡•á‡§Ç
                });

            } catch (error) {
                console.error("‡§à‡§Æ‡•á‡§≤ ‡§∏‡§æ‡§á‡§®‡§Ö‡§™ ‡§ï‡•á ‡§¶‡•å‡§∞‡§æ‡§® ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error);
                let errorMessage = "‡§ñ‡§æ‡§§‡§æ ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "‡§Ø‡§π ‡§à‡§Æ‡•á‡§≤ ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§π‡•Ä ‡§â‡§™‡§Ø‡•ã‡§ó ‡§Æ‡•á‡§Ç ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§ø‡§∏‡•Ä ‡§Ö‡§®‡•ç‡§Ø ‡§à‡§Æ‡•á‡§≤ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§≤‡•â‡§ó ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç‡•§";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§à‡§Æ‡•á‡§≤ ‡§™‡•ç‡§∞‡§æ‡§∞‡•Ç‡§™‡•§";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¨‡§π‡•Å‡§§ ‡§ï‡§Æ‡§ú‡•ã‡§∞ ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï ‡§Æ‡§ú‡§¨‡•Ç‡§§ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§ö‡•Å‡§®‡•á‡§Ç‡•§";
                }
                showModal(errorMessage, "‡§∏‡§æ‡§á‡§® ‡§Ö‡§™ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø");
            }
        }

        // ‡§à‡§Æ‡•á‡§≤/‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡•ã ‡§∏‡§Ç‡§≠‡§æ‡§≤‡§§‡§æ ‡§π‡•à
        async function handleEmailLogin() {
            const email = document.getElementById('login-email-input').value.trim();
            const password = document.getElementById('login-password-input').value.trim();

            if (!email || !password) {
                showModal("‡§ï‡•É‡§™‡§Ø‡§æ ‡§à‡§Æ‡•á‡§≤ ‡§î‡§∞ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§", "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø");
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const firebaseUser = userCredential.user;
                
                // Firebase Auth UID ‡§ï‡•á ‡§Ü‡§ß‡§æ‡§∞ ‡§™‡§∞ ‡§ê‡§™ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§ï‡•ã ‡§ñ‡•ã‡§ú‡•á‡§Ç ‡§î‡§∞ ‡§≤‡§ø‡§Ç‡§ï ‡§ï‡§∞‡•á‡§Ç
                await findAndLinkAppUserByAuthUid(firebaseUser.uid);

                showModal("‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§≤‡•â‡§ó ‡§á‡§® ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!", "‡§∏‡§´‡§≤‡§§‡§æ");

            } catch (error) {
                console.error("‡§à‡§Æ‡•á‡§≤ ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡•á ‡§¶‡•å‡§∞‡§æ‡§® ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error);
                let errorMessage = "‡§≤‡•â‡§ó ‡§á‡§® ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§à‡§Æ‡•á‡§≤ ‡§Ø‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°‡•§";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§à‡§Æ‡•á‡§≤ ‡§™‡•ç‡§∞‡§æ‡§∞‡•Ç‡§™‡•§";
                }
                showModal(errorMessage, "‡§≤‡•â‡§ó‡§ø‡§® ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø");
            }
        }


        // ‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ‡§ê‡§™-‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§Ü‡§à‡§°‡•Ä ‡§ï‡•á ‡§∏‡§æ‡§• ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡•ã ‡§∏‡§Ç‡§≠‡§æ‡§≤‡§§‡§æ ‡§π‡•à
        async function loginExistingUser() {
            const userId = document.getElementById('existing-user-id-input').value.trim();
            if (!userId) { showModal("‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡•Ä ‡§Ü‡§à‡§°‡•Ä ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§", "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø"); return; }
            
            // ‡§Ü‡§ó‡•á ‡§¨‡§¢‡§º‡§®‡•á ‡§∏‡•á ‡§™‡§π‡§≤‡•á currentUser ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§π‡•à ‡§Ø‡§π ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç
            // ‡§Ø‡§¶‡§ø ‡§®‡§π‡•Ä‡§Ç, ‡§§‡•ã ‡§ó‡•Å‡§Æ‡§®‡§æ‡§Æ ‡§∏‡§æ‡§á‡§®-‡§á‡§® ‡§ï‡§æ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡•Ä‡§ï‡§∞‡§£ ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§ï‡•Ä ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§
            // ‡§Ø‡§π ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§ï‡§ø ‡§ê‡§™ ‡§Ü‡§à‡§°‡•Ä ‡§ï‡•ã ‡§≤‡§ø‡§Ç‡§ï ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡§§‡•á ‡§∏‡§Æ‡§Ø ‡§π‡§Æ‡§æ‡§∞‡•á ‡§™‡§æ‡§∏ ‡§π‡§Æ‡•á‡§∂‡§æ ‡§è‡§ï Firebase ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ (‡§Ø‡§π‡§æ‡§Ç ‡§§‡§ï ‡§ï‡§ø ‡§ó‡•Å‡§Æ‡§®‡§æ‡§Æ) ‡§π‡•ã‡•§
            if (!auth.currentUser) {
                console.log("loginExistingUser: ‡§ï‡•ã‡§à ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® Firebase ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡§π‡•Ä‡§Ç, ‡§ó‡•Å‡§Æ‡§®‡§æ‡§Æ ‡§∏‡§æ‡§á‡§®-‡§á‡§® ‡§ï‡§æ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à‡•§");
                try {
                    await signInAnonymously(auth);
                    // ‡§®‡§è ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡•ã ‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è onAuthStateChanged ‡§ï‡•ã ‡§•‡•ã‡§°‡§º‡§æ ‡§∏‡§Æ‡§Ø ‡§¶‡•á‡§Ç
                    await new Promise(resolve => setTimeout(resolve, 500)); 
                } catch (anonError) {
                    console.error("‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ó‡•Å‡§Æ‡§®‡§æ‡§Æ ‡§∏‡§æ‡§á‡§®-‡§á‡§® ‡§ï‡•á ‡§¶‡•å‡§∞‡§æ‡§® ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", anonError);
                    showModal("‡§≤‡•â‡§ó ‡§á‡§® ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡•Ä‡§ï‡§∞‡§£ ‡§µ‡§ø‡§´‡§≤‡•§", "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø");
                    return;
                }
            }

            if (!auth.currentUser || !auth.currentUser.uid) {
                console.error("loginExistingUser: auth.currentUser ‡§Ø‡§æ ‡§á‡§∏‡§ï‡§æ UID ‡§∏‡§æ‡§á‡§®-‡§á‡§® ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§≠‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§");
                showModal("‡§≤‡•â‡§ó ‡§á‡§® ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡•Ä‡§ï‡§∞‡§£ ‡§°‡•á‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§", "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø");
                return;
            }

            console.log("‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§Ü‡§à‡§°‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§™‡§¢‡§º‡§®‡•á ‡§ï‡§æ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à:", userId, "‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® Firebase UID ‡§ï‡•á ‡§∏‡§æ‡§•:", auth.currentUser.uid);

            try {
                const userDocRef = doc(db, "users", userId);
                const userDoc = await getDoc(userDocRef); 
                if (!userDoc.exists()) {
                    showModal("‡§Ø‡§π ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§Ü‡§à‡§°‡•Ä ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø"); // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶
                    return;
                }
                
                const storedAuthUid = userDoc.data().authUid;
                const storedAuthType = userDoc.data().authType; // authType ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç
                const currentAuthUid = auth.currentUser.uid;

                if (storedAuthUid !== currentAuthUid) {
                    // ‡§¨‡•á‡§Æ‡•á‡§≤ ‡§™‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ
                    if (storedAuthType === 'anonymous' && auth.currentUser.isAnonymous) {
                        // ‡§Ø‡§¶‡§ø ‡§≠‡§Ç‡§°‡§æ‡§∞‡§ø‡§§ ‡§ñ‡§æ‡§§‡§æ ‡§ó‡•Å‡§Æ‡§®‡§æ‡§Æ ‡§π‡•à ‡§î‡§∞ ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® Firebase ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ó‡•Å‡§Æ‡§®‡§æ‡§Æ ‡§π‡•à,
                        // ‡§§‡•ã ‡§π‡§Æ ‡§ê‡§™ ‡§Ü‡§à‡§°‡•Ä ‡§ï‡•ã ‡§®‡§à ‡§ó‡•Å‡§Æ‡§®‡§æ‡§Æ Firebase UID ‡§∏‡•á ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§∏‡§Ç‡§¨‡§¶‡•ç‡§ß ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§
                        console.warn(`‡§ê‡§™ ‡§Ü‡§à‡§°‡•Ä ${userId} ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ó‡•Å‡§Æ‡§®‡§æ‡§Æ Auth UID ‡§¨‡•á‡§Æ‡•á‡§≤ ‡§ï‡§æ ‡§™‡§§‡§æ ‡§ö‡§≤‡§æ‡•§ ‡§®‡§à ‡§ó‡•Å‡§Æ‡§®‡§æ‡§Æ UID ‡§∏‡•á ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§∏‡§Ç‡§¨‡§¶‡•ç‡§ß ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à: ${currentAuthUid}`);
                        await updateDoc(userDocRef, { authUid: currentAuthUid });
                        // ‡§Ö‡§¨ ‡§ê‡§™ ‡§Ü‡§à‡§°‡•Ä ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§ó‡•Å‡§Æ‡§®‡§æ‡§Æ ‡§∏‡§§‡•ç‡§∞ ‡§∏‡•á ‡§ú‡•Å‡§°‡§º‡•Ä ‡§π‡•Å‡§à ‡§π‡•à‡•§
                        localStorage.setItem('arvindAppUserId', userId); // ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§Ø‡§π ‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π‡•Ä‡§§ ‡§π‡•à
                        await findAndLinkAppUserByAuthUid(currentAuthUid); // ‡§®‡§è ‡§≤‡§ø‡§Ç‡§ï ‡§ï‡•á ‡§∏‡§æ‡§• ‡§°‡•á‡§ü‡§æ ‡§™‡•Å‡§®‡§É ‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
                        showModal("‡§ó‡•á‡§∏‡•ç‡§ü ‡§Ü‡§à‡§°‡•Ä ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§™‡•Å‡§®‡§É ‡§∏‡§Ç‡§¨‡§¶‡•ç‡§ß ‡§ï‡•Ä ‡§ó‡§à‡•§", "‡§∏‡§´‡§≤‡§§‡§æ"); // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶
                        return; // ‡§∏‡§´‡§≤ ‡§™‡•Å‡§®‡§É ‡§∏‡§Ç‡§¨‡§¶‡•ç‡§ß‡§§‡§æ ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§¨‡§æ‡§π‡§∞ ‡§®‡§ø‡§ï‡§≤‡•á‡§Ç
                    } else {
                        // ‡§Ø‡§¶‡§ø ‡§Ø‡§π ‡§è‡§ï ‡§ó‡•Å‡§Æ‡§®‡§æ‡§Æ ‡§ñ‡§æ‡§§‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§Ø‡§æ ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® Firebase ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ó‡•Å‡§Æ‡§®‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à,
                        // ‡§§‡•ã ‡§Ø‡§π ‡§è‡§ï ‡§µ‡§æ‡§∏‡•ç‡§§‡§µ‡§ø‡§ï ‡§¨‡•á‡§Æ‡•á‡§≤ ‡§π‡•à‡•§
                        console.warn(`Auth UID ‡§¨‡•á‡§Æ‡•á‡§≤: ‡§≠‡§Ç‡§°‡§æ‡§∞‡§ø‡§§ ${storedAuthUid}, ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ${currentAuthUid}‡•§ ‡§ó‡•Å‡§Æ‡§®‡§æ‡§Æ ‡§™‡•Å‡§®‡§É ‡§∏‡§Ç‡§¨‡§¶‡•ç‡§ß‡§§‡§æ ‡§ï‡§æ ‡§™‡§∞‡§ø‡§¶‡•É‡§∂‡•ç‡§Ø ‡§®‡§π‡•Ä‡§Ç‡•§`);
                        showModal("‡§Ø‡§π ‡§Ü‡§à‡§°‡•Ä ‡§Ü‡§™‡§ï‡•á ‡§ñ‡§æ‡§§‡•á ‡§∏‡•á ‡§∏‡§Ç‡§¨‡§¶‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", "‡§≤‡•â‡§ó‡§ø‡§® ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø", () => {
                            showScreen('main-screen'); // ‡§Æ‡•ã‡§°‡§≤ ‡§¨‡§Ç‡§¶ ‡§π‡•ã‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§™‡§∞ ‡§∞‡•Ä‡§°‡§æ‡§Ø‡§∞‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç
                        });
                        return;
                    }
                }

                // ‡§Ø‡§¶‡§ø UID ‡§Æ‡•á‡§≤ ‡§ñ‡§æ‡§§‡•á ‡§π‡•à‡§Ç, ‡§Ø‡§æ ‡§Ø‡§¶‡§ø ‡§™‡•Å‡§®‡§É ‡§∏‡§Ç‡§¨‡§¶‡•ç‡§ß‡§§‡§æ ‡§π‡•Å‡§à ‡§π‡•à, ‡§§‡•ã ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§Ü‡§ó‡•á ‡§¨‡§¢‡§º‡•á‡§Ç
                localStorage.setItem('arvindAppUserId', userId);
                await findAndLinkAppUserByAuthUid(auth.currentUser.uid); // ‡§Ø‡§π ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ê‡§™ ‡§∏‡•á‡§ü‡§Ö‡§™ ‡§ï‡§∞‡•á‡§ó‡§æ
            } catch (error) {
                console.error("loginExistingUser ‡§ï‡•á ‡§¶‡•å‡§∞‡§æ‡§® ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:", error);
                showModal(`‡§≤‡•â‡§ó ‡§á‡§® ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message}. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§`, "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø"); // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶
            }
        }


        function loadMessages() {
            const chatMessages = document.getElementById('chat-messages');
            // ‡§™‡•Å‡§∞‡§æ‡§®‡•á ‡§∏‡§Ç‡§¶‡•á‡§∂‡•ã‡§Ç ‡§ï‡•ã ‡§∂‡•Ä‡§∞‡•ç‡§∑ ‡§™‡§∞ ‡§¶‡§ø‡§ñ‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ü‡§æ‡§á‡§Æ‡§∏‡•ç‡§ü‡•à‡§Æ‡•ç‡§™ ‡§Ü‡§∞‡•ã‡§π‡•Ä ‡§ï‡•ç‡§∞‡§Æ ‡§Æ‡•á‡§Ç ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§ï‡§∞‡•á‡§Ç
            const q = query(collection(db, "chats"), orderBy("timestamp", "asc"), limit(50));
            unsubscribeChat = onSnapshot(q, (querySnapshot) => {
                chatMessages.innerHTML = "";
                // ‡§Ø‡§¶‡§ø ‡§Ü‡§∞‡•ã‡§π‡•Ä ‡§ï‡•ç‡§∞‡§Æ ‡§Æ‡•á‡§Ç ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à ‡§§‡•ã ‡§â‡§≤‡§ü‡§®‡•á ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à
                querySnapshot.docs.forEach(doc => {
                    const msg = doc.data();
                    const bubble = document.createElement('div');
                    const isMe = msg.senderId === applicationUserId;
                    bubble.className = `p-3 rounded-xl max-w-xs ${isMe ? 'bg-indigo-500 text-white self-end' : 'bg-slate-200 self-start'}`;
                    bubble.innerHTML = `${!isMe ? `<div class="font-bold text-xs text-indigo-600">${msg.senderName}</div>` : ''}<div>${msg.text}</div>`;
                    chatMessages.appendChild(bubble);
                });
                // ‡§®‡§µ‡•Ä‡§®‡§§‡§Æ ‡§∏‡§Ç‡§¶‡•á‡§∂‡•ã‡§Ç ‡§ï‡•ã ‡§¶‡§ø‡§ñ‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§®‡•Ä‡§ö‡•á ‡§∏‡•ç‡§ï‡•ç‡§∞‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç
                if(chatMessages.scrollHeight > chatMessages.clientHeight) {
                  chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            });
        }

        async function sendMessage(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (text === "") return;
            input.value = "";
            await addDoc(collection(db, "chats"), { text: text, senderId: applicationUserId, senderName: currentUserName, timestamp: serverTimestamp() });
        }
        
        async function updateUserName() {
            const newName = document.getElementById('profile-name-input').value.trim();
            if (!newName) { showModal("‡§®‡§æ‡§Æ ‡§ñ‡§æ‡§≤‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ‡•§", "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø"); return; } // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ
            await updateDoc(doc(db, "users", applicationUserId), { name: newName });
            currentUserName = newName;
            document.getElementById('welcome-message').textContent = `‡§®‡§Æ‡§∏‡•ç‡§§‡•á, ${currentUserName}!`;
            showModal("‡§®‡§æ‡§Æ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!", "‡§∏‡§´‡§≤‡§§‡§æ"); // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ
        }
        
        function handleLogout() {
            signOut(auth).then(() => {
                localStorage.removeItem('arvindAppUserId');
                currentUser = null;
                applicationUserId = null;
                window.location.reload();
            });
        }
        
        // --- EVENT LISTENERS ---
        window.addEventListener('load', () => {
            console.log("‡§µ‡§ø‡§Ç‡§°‡•ã ‡§≤‡•ã‡§° ‡§π‡•Å‡§à‡•§ ‡§™‡•ç‡§∞‡§æ‡§∞‡§Ç‡§≠‡§ø‡§ï ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§Ö‡§®‡•Å‡§ï‡•ç‡§∞‡§Æ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à‡•§");
            document.getElementById('loading-screen').classList.add('active'); // ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø ‡§≤‡•ã‡§°‡§ø‡§Ç‡§ó ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§™‡§π‡§≤‡•á ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§π‡•à
            setTimeout(() => {
                document.getElementById('loading-screen').classList.remove('active'); // ‡§≤‡•ã‡§°‡§ø‡§Ç‡§ó ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§õ‡§ø‡§™‡§æ‡§è‡§Å
                document.getElementById('intro-screen').classList.add('active'); // ‡§™‡§∞‡§ø‡§ö‡§Ø ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å
                initializeFirebase(); // ‡§∏‡•Ä‡§ß‡•á Firebase init ‡§ï‡•ã ‡§ï‡•â‡§≤ ‡§ï‡§∞‡•á‡§Ç
            }, 1000); // ‡§≤‡•ã‡§°‡§ø‡§Ç‡§ó ‡§¶‡§ø‡§ñ‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è 1 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§ï‡•Ä ‡§¶‡•á‡§∞‡•Ä
        });
        document.querySelectorAll('.back-btn').forEach(btn => btn.addEventListener('click', goBack));
        messageModal.okBtn.addEventListener('click', hideModals);

        document.getElementById('have-account-btn').addEventListener('click', () => showScreen('have-account-screen'));
        document.getElementById('email-signup-btn').addEventListener('click', () => showScreen('email-signup-screen'));
        document.getElementById('email-login-btn').addEventListener('click', () => showScreen('email-login-screen')); // ‡§à‡§Æ‡•á‡§≤ ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§®‡§Ø‡§æ ‡§¨‡§ü‡§®
        document.getElementById('continue-as-guest-btn').addEventListener('click', () => showScreen('new-user-screen')); // ‡§â‡§∏ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§™‡§∞ ‡§∞‡•Ä‡§°‡§æ‡§Ø‡§∞‡•á‡§ï‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç ‡§ú‡§π‡§æ‡§Å ‡§ó‡•á‡§∏‡•ç‡§ü ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à
        
        document.getElementById('create-guest-user-btn').addEventListener('click', handleGuestSignIn); // create-user-btn ‡§∏‡•á ‡§®‡§æ‡§Æ ‡§¨‡§¶‡§≤‡§æ ‡§ó‡§Ø‡§æ
        document.getElementById('signup-btn').addEventListener('click', handleEmailSignup); // ‡§®‡§Ø‡§æ ‡§∏‡§æ‡§á‡§®‡§Ö‡§™ ‡§¨‡§ü‡§®
        document.getElementById('email-login-submit-btn').addEventListener('click', handleEmailLogin); // ‡§à‡§Æ‡•á‡§≤/‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§ï‡•á ‡§≤‡§ø‡§è ‡§®‡§Ø‡§æ ‡§≤‡•â‡§ó‡§ø‡§® ‡§¨‡§ü‡§®
        document.getElementById('login-btn').addEventListener('click', loginExistingUser);
        document.getElementById('chat-form').addEventListener('submit', sendMessage);
        document.getElementById('copy-id-btn').addEventListener('click', () => {
            // ‡§è‡§ï ‡§Ö‡§∏‡•ç‡§•‡§æ‡§Ø‡•Ä ‡§á‡§®‡§™‡•Å‡§ü ‡§§‡§§‡•ç‡§µ ‡§¨‡§®‡§æ‡§è‡§Å
            const tempInput = document.createElement('input');
            tempInput.value = applicationUserId;
            document.body.appendChild(tempInput);
            tempInput.select();
            try {
                // iframes ‡§Æ‡•á‡§Ç ‡§¨‡•á‡§π‡§§‡§∞ ‡§∏‡§Ç‡§ó‡§§‡§§‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è document.execCommand('copy') ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç
                document.execCommand('copy');
                showModal("‡§Ü‡§à‡§°‡•Ä ‡§ï‡•â‡§™‡•Ä ‡§π‡•ã ‡§ó‡§Ø‡§æ!", "‡§∏‡§´‡§≤‡§§‡§æ"); // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶
            } catch (err) {
                console.error('‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤:', err);
                showModal("‡§Ü‡§à‡§°‡•Ä ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Æ‡•à‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç‡•§", "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø"); // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶
            }
            document.body.removeChild(tempInput);
        });
        document.getElementById('save-name-btn').addEventListener('click', updateUserName);
        document.getElementById('logout-btn').addEventListener('click', handleLogout);

        document.getElementById('nav-home').addEventListener('click', () => showScreen('home-screen', true));
        document.getElementById('nav-chat').addEventListener('click', () => showScreen('chat-screen', true));
        document.getElementById('nav-profile').addEventListener('click', () => {
            document.getElementById('display-user-id').textContent = applicationUserId;
            document.getElementById('profile-name-input').value = currentUserName;
            showScreen('profile-screen', true);
        });

        document.getElementById('prep-by-syllabus-btn').addEventListener('click', () => { populateSubjects(); showScreen('jee-prep-setup-screen'); });
        document.getElementById('daily-rank-test-btn').addEventListener('click', startDailyTest);
        document.getElementById('scoreboard-btn').addEventListener('click', loadScoreboard);
        document.getElementById('feedback-btn').addEventListener('click', openFeedbackModal);
        
        // ‡§™‡•ã‡§≤ ‡§¨‡§ü‡§® ‡§á‡§µ‡•á‡§Ç‡§ü ‡§≤‡§ø‡§∏‡§®‡§∞
        thumbsUpBtn.addEventListener('click', () => submitVote('thumbsUp'));
        thumbsDownBtn.addEventListener('click', () => submitVote('thumbsDown'));

        document.getElementById('generate-test-btn').addEventListener('click', async () => {
            const btn = document.getElementById('generate-test-btn');
            const subjects = [...document.querySelectorAll('input[name="subject"]:checked')].map(el => el.value);
            if (subjects.length === 0) {
                showModal("‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§è‡§ï ‡§µ‡§ø‡§∑‡§Ø ‡§ö‡•Å‡§®‡•á‡§Ç‡•§", "‡§§‡•ç‡§∞‡•Å‡§ü‡§ø"); // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ
                return;
            }

            // ‡§≤‡•ã‡§°‡§ø‡§Ç‡§ó ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§Ö‡§¨ generateTest ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§π‡•Ä ‡§∏‡§Ç‡§≠‡§æ‡§≤‡•Ä ‡§ú‡§æ‡§§‡•Ä ‡§π‡•à
            const examData = await generateTest(true); 

            if (examData) {
                hideModals();
                startExam(examData);
            }
        });

        document.getElementById('submit-exam-btn').addEventListener('click', () => {
            if (currentExamData.type === 'daily') {
                showModal("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§ü‡•á‡§∏‡•ç‡§ü ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?", "‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ú‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç", () => submitExam()); // ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶
            } else {
                submitExam();
            }
        });
        document.getElementById('back-to-home-btn').addEventListener('click', () => showScreen('home-screen', true));
        feedbackModal.cancelBtn.addEventListener('click', hideModals);
        feedbackModal.submitBtn.addEventListener('click', submitFeedback);
    </script>
</body>
</html>
